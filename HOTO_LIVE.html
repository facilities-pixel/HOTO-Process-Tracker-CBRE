<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOTO Process Tracker - High Rise Building</title>
    
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* ===== LAYOUT ===== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ===== HEADER ===== */
        .site-header {
            background: linear-gradient(135deg, #1F3765 0%, #2A4A8A 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(31, 55, 101, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== DATA CONTROLS ===== */
        .data-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #1F3765;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #f0f7ff;
            border-color: #1F3765;
            transform: translateY(-2px);
        }
        
        /* ===== TABS ===== */
        .main-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            background: white;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }
        
        .tab:hover {
            background: #f8fafc;
            color: #1F3765;
        }
        
        .tab.active {
            color: #1F3765;
            border-bottom-color: #D2785A;
            background: #f8fafc;
        }
        
        .tab i {
            margin-right: 10px;
        }
        
        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== DASHBOARD KPI CARDS (UPDATED TO MATCH ANALYTICS) ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-top: 6px solid;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .kpi-title {
            font-size: 1.1rem;
            color: #435254;
            font-weight: 600;
        }
        
        .kpi-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: #1F3765;
            margin: 15px 0;
            line-height: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress-container {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
        }
        
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ===== TOWER PROGRESS CHART ===== */
        .tower-progress-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tower-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .chart-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .chart-filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .chart-filter-btn:hover {
            background: #f0f7ff;
            border-color: #1F3765;
        }
        
        .chart-filter-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        .tower-progress-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .tower-chart-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tower-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .tower-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1F3765;
        }
        
        /* ===== PROCESS CHART ITEM ===== */
        .process-chart-item {
            margin-bottom: 15px;
        }
        
        .process-name {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #435254;
        }
        
        .process-percent {
            font-weight: 700;
            color: #1F3765;
        }
        
        /* ===== FORMS ===== */
        .process-form {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #1F3765;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #435254;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3E7CA6;
            box-shadow: 0 0 0 3px rgba(62, 124, 166, 0.1);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: #1F3765;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2A4A8A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(31, 55, 101, 0.3);
        }
        
        .btn-secondary {
            background: #80BBAD;
            color: #435254;
        }
        
        .btn-secondary:hover {
            background: #6CA89A;
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background: #D2785A;
            color: white;
        }
        
        .btn-accent:hover {
            background: #C1694A;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        /* ===== TOWER SECTION ===== */
        .tower-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .tower-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tower-btn {
            padding: 12px 25px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .tower-btn:hover {
            background: #f0f7ff;
            border-color: #3E7CA6;
        }
        
        .tower-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        /* ===== FLOOR SELECTION ===== */
        .floor-selection {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: block !important;
        }
        
        .floor-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .floor-btn {
            padding: 12px 5px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .floor-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
        }
        
        .floor-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
        }
        
        /* ===== FLAT SELECTION ===== */
        .flat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 25px 0;
        }
        
        .flat-item {
            padding: 15px 10px;
            text-align: center;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 1.1rem;
            position: relative;
        }
        
        .flat-item:hover {
            border-color: #3E7CA6;
            background: #f0f7ff;
            transform: translateY(-2px);
        }
        
        .flat-item.selected {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 4px 12px rgba(31, 55, 101, 0.3);
        }
        
        .flat-item.refuge {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
            font-weight: 700;
            position: relative;
        }
        
        .flat-item.refuge:hover {
            background: #ffeaa7;
        }
        
        .flat-item.refuge.selected {
            background: #ffc107;
            color: #856404;
            border-color: #e0a800;
        }
        
        /* Refuge indicator */
        .refuge-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ===== DETAILS MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .data-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3E7CA6;
        }
        
        .data-section h4 {
            color: #1F3765;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .data-field {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .data-field:hover {
            border-color: #3E7CA6;
            box-shadow: 0 2px 8px rgba(62, 124, 166, 0.1);
        }
        
        .field-label {
            font-weight: 600;
            color: #435254;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .field-value {
            color: #333;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* ===== SNAG CATEGORY SECTION ===== */
        .snag-category {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3E7CA6;
            transition: all 0.3s;
        }
        
        .snag-category:hover {
            box-shadow: 0 2px 8px rgba(62, 124, 166, 0.1);
        }
        
        .snag-category h5 {
            color: #1F3765;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ===== MULTIPLE VENDORS ===== */
        .vendor-form {
            background: #e9f7fe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
            border: 2px dashed #3E7CA6;
            transition: all 0.3s;
        }
        
        .vendor-form:hover {
            border-color: #1F3765;
        }
        
        .vendor-form.hidden {
            display: none;
        }
        
        .vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .remove-vendor {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .remove-vendor:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        
        /* ===== DEVIATIONS SECTION ===== */
        .deviation-item {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
        }
        
        .deviation-item:hover {
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
        
        .deviation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .deviation-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-resolved {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-not-resolved {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* ===== ANALYTICS STYLES ===== */
        .analytics-controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .date-range-filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .quick-filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .quick-filter-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .quick-filter-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
        }
        
        .quick-filter-btn.active {
            background: #1F3765;
            color: white;
            border-color: #1F3765;
            box-shadow: 0 2px 8px rgba(31, 55, 101, 0.3);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.2rem;
            color: #1F3765;
            font-weight: 600;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .report-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .report-btn:hover {
            background: #e9ecef;
            border-color: #3E7CA6;
            transform: translateY(-2px);
        }
        
        .canvas-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        
        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 10px 0;
            color: #721c24;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-message i {
            color: #dc3545;
        }
        
        .validation-error {
            border-color: #dc3545 !important;
            background: #fff5f5;
        }
        
        /* ===== RESOLUTION DROPDOWN ===== */
        .resolution-dropdown {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .resolution-dropdown select {
            width: auto;
            min-width: 120px;
        }
        
        /* ===== DATE TIME DISPLAY ===== */
        .datetime-display {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ===== EDIT BUTTON STYLES ===== */
        .edit-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        /* ===== COLOR THEMES ===== */
        .color-key { background: #80BBAD; border-color: #80BBAD; }
        .color-snag { background: #17E88F; border-color: #17E88F; }
        .color-visit { background: #DBD99A; border-color: #DBD99A; }
        .color-hoto { background: #3E7CA6; border-color: #3E7CA6; }
        .color-interior { background: #885073; border-color: #885073; }
        .color-movein { background: #1F3765; border-color: #1F3765; }
        .color-project { background: #6f42c1; border-color: #6f42c1; }
        .color-crm { background: #20c997; border-color: #20c997; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tower-progress-chart {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .site-header {
                flex-direction: column;
                text-align: center;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .tower-progress-chart {
                grid-template-columns: 1fr;
            }
            
            .main-tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 15px;
                text-align: left;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .floor-buttons {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .flat-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .data-row {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .flat-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .floor-buttons {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
        }
        
        /* ===== NOTIFICATION STYLES ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #212529; }
        .notification.info { background: #17a2b8; }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== TEMPLATE INSTRUCTIONS ===== */
        .template-instructions {
            background: #fff3cd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        
        .required-fields {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .required-field {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .field-name {
            font-weight: 600;
            color: #1F3765;
        }
        
        .field-type {
            font-size: 0.9rem;
            color: #666;
            margin-left: 5px;
        }
        
        /* ===== IMPORT SUMMARY ===== */
        .import-summary {
            background: #e9f7fe;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        /* ===== SETUP STEPS ===== */
        .setup-step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .setup-step:last-child {
            border-bottom: none;
        }
        
        .setup-instruction {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .setup-instruction ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .setup-instruction li {
            margin-bottom: 8px;
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="site-header">
            <div class="header-left">
                <h1>
                    <i class="fas fa-building"></i>
                    HOTO Process Tracker
                </h1>
                <p>High Rise Building Complex - Real-time Progress Tracking</p>
            </div>
            <div class="header-right">
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="currentDate">Loading...</span>
                </div>
                <button class="control-btn" onclick="refreshData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="control-btn" onclick="openTab('excel-processor')">
                    <i class="fas fa-file-excel"></i>
                    Excel Processor
                </button>
                <button class="control-btn" onclick="openTab('integration')" title="Google Sheets Integration">
                    <i class="fas fa-plug"></i>
                    <span id="connectionIndicator" style="color: #28a745;">‚óè</span>
                </button>
            </div>
        </header>
        
        <!-- TABS -->
        <div class="main-tabs">
            <div class="tab active" onclick="openTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="tab" onclick="openTab('key-handover')">
                <i class="fas fa-key"></i> Key Handover
            </div>
            <div class="tab" onclick="openTab('snagging')">
                <i class="fas fa-search"></i> CBRE Snagging
            </div>
            <!-- MOVED PROJECT/MEP AND CRM AFTER SNAGGING -->
            <div class="tab" onclick="openTab('project-mep')">
                <i class="fas fa-tools"></i> Project/MEP
            </div>
            <div class="tab" onclick="openTab('crm')">
                <i class="fas fa-phone-alt"></i> CRM
            </div>
            <div class="tab" onclick="openTab('first-visit')">
                <i class="fas fa-calendar-check"></i> First Visit
            </div>
            <div class="tab" onclick="openTab('handover')">
                <i class="fas fa-handshake"></i> Handover
            </div>
            <div class="tab" onclick="openTab('interiors')">
                <i class="fas fa-hammer"></i> Interiors
            </div>
            <div class="tab" onclick="openTab('move-in')">
                <i class="fas fa-home"></i> Move-in
            </div>
            <div class="tab" onclick="openTab('excel-processor')">
                <i class="fas fa-file-excel"></i> Excel Processor
            </div>
            <div class="tab" onclick="openTab('integration')">
                <i class="fas fa-plug"></i> Integration
            </div>
            <!-- NEW ANALYTICS TAB -->
            <div class="tab" onclick="openTab('analytics')">
                <i class="fas fa-chart-bar"></i> Analytics
            </div>
        </div>
        
        <!-- DASHBOARD TAB -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card" style="border-top-color: #80BBAD;">
                    <div class="kpi-header">
                        <div class="kpi-title">Key Handovers</div>
                        <i class="fas fa-key fa-2x" style="color: #80BBAD;"></i>
                    </div>
                    <div class="kpi-value" id="totalKeyHandovers">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="keyHandoverPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="keyHandoverProgress" style="width: 0%; background-color: #80BBAD;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #17E88F;">
                    <div class="kpi-header">
                        <div class="kpi-title">CBRE Snagging</div>
                        <i class="fas fa-search fa-2x" style="color: #17E88F;"></i>
                    </div>
                    <div class="kpi-value" id="totalSnagging">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="snaggingPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="snaggingProgress" style="width: 0%; background-color: #17E88F;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- MOVED PROJECT/MEP KPI AFTER SNAGGING -->
                <div class="kpi-card" style="border-top-color: #6f42c1;">
                    <div class="kpi-header">
                        <div class="kpi-title">Project/MEP</div>
                        <i class="fas fa-tools fa-2x" style="color: #6f42c1;"></i>
                    </div>
                    <div class="kpi-value" id="totalProjectMEP">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="projectMEPPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="projectMEPProgress" style="width: 0%; background-color: #6f42c1;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- MOVED CRM KPI AFTER SNAGGING -->
                <div class="kpi-card" style="border-top-color: #20c997;">
                    <div class="kpi-header">
                        <div class="kpi-title">CRM</div>
                        <i class="fas fa-phone-alt fa-2x" style="color: #20c997;"></i>
                    </div>
                    <div class="kpi-value" id="totalCRM">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="crmPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="crmProgress" style="width: 0%; background-color: #20c997;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #DBD99A;">
                    <div class="kpi-header">
                        <div class="kpi-title">First Visits</div>
                        <i class="fas fa-calendar-check fa-2x" style="color: #DBD99A;"></i>
                    </div>
                    <div class="kpi-value" id="totalFirstVisits">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="firstVisitPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="firstVisitProgress" style="width: 0%; background-color: #DBD99A;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #3E7CA6;">
                    <div class="kpi-header">
                        <div class="kpi-title">Handovers</div>
                        <i class="fas fa-handshake fa-2x" style="color: #3E7CA6;"></i>
                    </div>
                    <div class="kpi-value" id="totalHandovers">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="handoverPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="handoverProgress" style="width: 0%; background-color: #3E7CA6;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #885073;">
                    <div class="kpi-header">
                        <div class="kpi-title">Interiors</div>
                        <i class="fas fa-hammer fa-2x" style="color: #885073;"></i>
                    </div>
                    <div class="kpi-value" id="totalInteriors">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="interiorPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="interiorProgress" style="width: 0%; background-color: #885073;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card" style="border-top-color: #1F3765;">
                    <div class="kpi-header">
                        <div class="kpi-title">Move-ins</div>
                        <i class="fas fa-home fa-2x" style="color: #1F3765;"></i>
                    </div>
                    <div class="kpi-value" id="totalMoveins">0</div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Completion</span>
                            <span id="moveinPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="moveinProgress" style="width: 0%; background-color: #1F3765;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tower Progress Chart Section -->
            <div class="tower-progress-section">
                <div class="tower-progress-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Tower-wise Progress Analysis
                    </h2>
                    <div class="chart-filters">
                        <button class="chart-filter-btn active" onclick="filterChartData('all')">All Processes</button>
                        <button class="chart-filter-btn" onclick="filterChartData('key')">Key Handover</button>
                        <button class="chart-filter-btn" onclick="filterChartData('snag')">CBRE Snagging</button>
                        <button class="chart-filter-btn" onclick="filterChartData('project')">Project/MEP</button>
                        <button class="chart-filter-btn" onclick="filterChartData('crm')">CRM</button>
                        <button class="chart-filter-btn" onclick="filterChartData('visit')">First Visit</button>
                        <button class="chart-filter-btn" onclick="filterChartData('hoto')">Handover</button>
                        <button class="chart-filter-btn" onclick="filterChartData('interior')">Interiors</button>
                        <button class="chart-filter-btn" onclick="filterChartData('movein')">Move-in</button>
                    </div>
                </div>
                
                <div class="tower-progress-chart" id="tower-progress-chart">
                    <!-- Tower charts will be dynamically generated here -->
                </div>
            </div>
        </div>
        
        <!-- KEY HANDOVER TAB -->
        <div id="key-handover-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-key"></i>
                    Key Handover - Project Team to HOTO Team
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('key-handover', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('key-handover', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('key-handover', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="key-handover-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="key-handover-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Key Handover Form -->
                <div id="key-handover-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('key_handover')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-edit"></i>
                        Key Handover Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="keyHandoverFlat">Flat Number *</label>
                            <input type="text" id="keyHandoverFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="keyHandoverTower">Tower *</label>
                            <input type="text" id="keyHandoverTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverPerson">Handover Person *</label>
                            <input type="text" id="handoverPerson" placeholder="Name of person handing over keys">
                        </div>
                        <div class="form-group">
                            <label for="receivedByCBRE">Received by CBRE Person *</label>
                            <input type="text" id="receivedByCBRE" placeholder="Name of CBRE person receiving keys">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverDate">Handover Date *</label>
                            <input type="date" id="handoverDate" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allKeysNotHanded" onchange="toggleKeyRemarks()">
                            <label for="allKeysNotHanded"><strong>All Keys Not Handed Over</strong></label>
                        </div>
                    </div>
                    
                    <div id="keyRemarksContainer" class="conditional-remarks" style="display: none;">
                        <label for="keyRemarks">Remarks for Incomplete Keys *</label>
                        <textarea id="keyRemarks" rows="3" placeholder="Specify which keys are missing or incomplete..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveKeyHandover()">
                            <i class="fas fa-save"></i> Save Key Handover
                        </button>
                        <button class="btn btn-secondary" onclick="resetKeyForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CBRE SNAGGING TAB -->
        <div id="snagging-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-search"></i>
                    CBRE Snagging Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('snagging', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('snagging', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('snagging', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="snagging-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="snagging-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Snagging Form -->
                <div id="snagging-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('snagging')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-check"></i>
                        CBRE Snagging Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="snaggingFlat">Flat Number *</label>
                            <input type="text" id="snaggingFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="snaggingTower">Tower *</label>
                            <input type="text" id="snaggingTower" readonly>
                        </div>
                    </div>
                    
                    <!-- MEP Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-bolt"></i> MEP Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mepInspector">MEP Inspector Name</label>
                                <input type="text" id="mepInspector" placeholder="Name of MEP inspector">
                            </div>
                            <div class="form-group">
                                <label for="mepStartDate">MEP Start Date</label>
                                <input type="date" id="mepStartDate">
                            </div>
                            <div class="form-group">
                                <label for="mepEndDate">MEP End Date</label>
                                <input type="date" id="mepEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="mepCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="mepCompleted"><strong>MEP Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Civil Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-building"></i> Civil Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="civilInspector">Civil Inspector Name</label>
                                <input type="text" id="civilInspector" placeholder="Name of civil inspector">
                            </div>
                            <div class="form-group">
                                <label for="civilStartDate">Civil Start Date</label>
                                <input type="date" id="civilStartDate">
                            </div>
                            <div class="form-group">
                                <label for="civilEndDate">Civil End Date</label>
                                <input type="date" id="civilEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="civilCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="civilCompleted"><strong>Civil Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Electrical Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-plug"></i> Electrical Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="electricalInspector">Electrical Inspector Name</label>
                                <input type="text" id="electricalInspector" placeholder="Name of electrical inspector">
                            </div>
                            <div class="form-group">
                                <label for="electricalStartDate">Electrical Start Date</label>
                                <input type="date" id="electricalStartDate">
                            </div>
                            <div class="form-group">
                                <label for="electricalEndDate">Electrical End Date</label>
                                <input type="date" id="electricalEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="electricalCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="electricalCompleted"><strong>Electrical Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Water & Slopes Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-tint"></i> Water & Slopes Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="waterInspector">Water & Slopes Inspector Name</label>
                                <input type="text" id="waterInspector" placeholder="Name of water & slopes inspector">
                            </div>
                            <div class="form-group">
                                <label for="waterStartDate">Water & Slopes Start Date</label>
                                <input type="date" id="waterStartDate">
                            </div>
                            <div class="form-group">
                                <label for="waterEndDate">Water & Slopes End Date</label>
                                <input type="date" id="waterEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="waterCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="waterCompleted"><strong>Water & Slopes Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AC Drain Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-wind"></i> AC Drain Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="acDrainInspector">AC Drain Inspector Name</label>
                                <input type="text" id="acDrainInspector" placeholder="Name of AC drain inspector">
                            </div>
                            <div class="form-group">
                                <label for="acDrainStartDate">AC Drain Start Date</label>
                                <input type="date" id="acDrainStartDate">
                            </div>
                            <div class="form-group">
                                <label for="acDrainEndDate">AC Drain End Date</label>
                                <input type="date" id="acDrainEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="acDrainCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="acDrainCompleted"><strong>AC Drain Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tiles Snagging -->
                    <div class="snag-category">
                        <h5><i class="fas fa-square"></i> Tiles Snagging</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tilesInspector">Tiles Inspector Name</label>
                                <input type="text" id="tilesInspector" placeholder="Name of tiles inspector">
                            </div>
                            <div class="form-group">
                                <label for="tilesStartDate">Tiles Start Date</label>
                                <input type="date" id="tilesStartDate">
                            </div>
                            <div class="form-group">
                                <label for="tilesEndDate">Tiles End Date</label>
                                <input type="date" id="tilesEndDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="tilesCompleted" onchange="checkAllSnaggingCompleted()">
                                <label for="tilesCompleted"><strong>Tiles Completed</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="snagRemarksContainer" class="conditional-remarks">
                        <label for="snagRemarks">Remarks for Incomplete Areas</label>
                        <textarea id="snagRemarks" rows="3" placeholder="Specify which areas are incomplete and details..."></textarea>
                    </div>
                    
                    <div class="form-group" id="followupDateContainer">
                        <label for="followupDate">Follow-up Date</label>
                        <input type="date" id="followupDate">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveSnagging()" id="saveSnaggingBtn">
                            <i class="fas fa-save"></i> Save Snagging
                        </button>
                        <button class="btn btn-primary" onclick="moveToProjectMEP()" id="moveToProjectMEPBtn" style="display: none;">
                            <i class="fas fa-arrow-right"></i> Save & Move to Project/MEP
                        </button>
                        <button class="btn btn-secondary" onclick="resetSnagForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PROJECT/MEP TAB (MOVED AFTER SNAGGING) -->
        <div id="project-mep-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                    Project/MEP Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('project-mep', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('project-mep', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('project-mep', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="project-mep-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="project-mep-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Project/MEP Form -->
                <div id="project-mep-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('project_mep')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        Project/MEP Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectMEPFlat">Flat Number *</label>
                            <input type="text" id="projectMEPFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="projectMEPTower">Tower *</label>
                            <input type="text" id="projectMEPTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="snagsStatus">Snags Status by Project Team</label>
                        <select id="snagsStatus">
                            <option value="attended">Attended</option>
                            <option value="not_attended">Not Attended</option>
                            <option value="partial">Partially Attended</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmationDate">Confirmation Date</label>
                        <input type="date" id="confirmationDate">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cbreChecked">CBRE Team Checked</label>
                            <select id="cbreChecked" onchange="toggleCBRECheckedDate()">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group" id="cbreCheckedDateContainer" style="display: none;">
                            <label for="cbreCheckedDate">CBRE Checked Date</label>
                            <input type="date" id="cbreCheckedDate">
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveProjectMEP()">
                            <i class="fas fa-save"></i> Save Project/MEP
                        </button>
                        <button class="btn btn-primary" onclick="moveToCRM()">
                            <i class="fas fa-arrow-right"></i> Move to CRM
                        </button>
                        <button class="btn btn-secondary" onclick="resetProjectMEPForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CRM TAB (MOVED AFTER SNAGGING) -->
        <div id="crm-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-phone-alt"></i>
                    CRM Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('crm', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('crm', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('crm', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="crm-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="crm-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- CRM Form -->
                <div id="crm-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('crm')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-clipboard-list"></i>
                        CRM Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="crmFlat">Flat Number *</label>
                            <input type="text" id="crmFlat" readonly>
                            <div class="datetime-display" id="crmFlatDateTime">
                                <i class="fas fa-clock"></i>
                                <span>Date & time will appear after selection</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="crmTower">Tower *</label>
                            <input type="text" id="crmTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="3" placeholder="Description of the issue or requirement"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="informedTo">Informed To</label>
                            <select id="informedTo">
                                <option value="mep">MEP</option>
                                <option value="civil">Civil</option>
                                <option value="facilities">Facilities</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" onchange="toggleFollowupDate()">
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" id="followupDateCRMContainer">
                        <label for="followupDateCRM">Follow-up Date</label>
                        <input type="date" id="followupDateCRM">
                    </div>
                    
                    <div class="form-group">
                        <label for="remarksCRM">Remarks (Optional)</label>
                        <textarea id="remarksCRM" rows="2" placeholder="Additional remarks..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveCRM()">
                            <i class="fas fa-save"></i> Save CRM
                        </button>
                        <button class="btn btn-info" onclick="viewFlatDetails()">
                            <i class="fas fa-eye"></i> View All Details
                        </button>
                        <button class="btn btn-secondary" onclick="resetCRMForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FIRST VISIT TAB -->
        <div id="first-visit-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    Customer First Visit
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('first-visit', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('first-visit', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('first-visit', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="first-visit-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="first-visit-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- First Visit Form -->
                <div id="first-visit-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('first_visit')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-user-check"></i>
                        First Visit Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstVisitFlat">Flat Number *</label>
                            <input type="text" id="firstVisitFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="firstVisitTower">Tower *</label>
                            <input type="text" id="firstVisitTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ownerName">Owner Name *</label>
                            <input type="text" id="ownerName" placeholder="Full name of owner">
                        </div>
                        <div class="form-group">
                            <label for="ownerPhone">Owner Phone *</label>
                            <input type="tel" id="ownerPhone" placeholder="10-digit mobile number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="visitDateTime">Visit Date & Time *</label>
                            <input type="datetime-local" id="visitDateTime">
                        </div>
                        <div class="form-group">
                            <label for="hotMember">HOT Team Member *</label>
                            <input type="text" id="hotMember" placeholder="Name of HOT team member">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="ownerWillInformDate" onchange="toggleHandoverDate()">
                            <label for="ownerWillInformDate"><strong>Owner will inform the date</strong></label>
                        </div>
                    </div>
                    
                    <div class="form-row" id="handoverSuggestedContainer">
                        <div class="form-group">
                            <label for="handoverSuggested">Handover Date Suggested</label>
                            <input type="date" id="handoverSuggested">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="goingForThirdParty" onchange="toggleThirdPartyForm()">
                            <label for="goingForThirdParty"><strong>Going for Third Party Inspection</strong></label>
                        </div>
                    </div>
                    
                    <!-- Third Party Inspection Form -->
                    <div id="thirdPartyForm" style="display: none;">
                        <h4 class="section-title">
                            <i class="fas fa-clipboard-list"></i>
                            Third Party Inspection Details
                        </h4>
                        
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="dateNotConfirmed" onchange="toggleThirdPartySubForm()">
                                <label for="dateNotConfirmed"><strong>Date Not Confirmed (Save First Visit Only)</strong></label>
                            </div>
                        </div>
                        
                        <div id="thirdPartySubForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="thirdPartyDateConfirmed">Date Confirmed *</label>
                                    <input type="date" id="thirdPartyDateConfirmed">
                                </div>
                                <div class="form-group">
                                    <label for="reportReceivedDate">Report Received Date</label>
                                    <input type="date" id="reportReceivedDate">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Report Copy Type</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="softCopy">
                                        <label for="softCopy">Soft Copy</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="hardCopy">
                                        <label for="hardCopy">Hard Copy</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="informedToProjectTeam">Informed to Project Team</label>
                                    <select id="informedToProjectTeam" onchange="toggleProjectTeamDate()">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div class="form-group" id="projectTeamDateContainer" style="display: none;">
                                    <label for="projectTeamInformedDate">Project Team Informed Date</label>
                                    <input type="date" id="projectTeamInformedDate">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cbreCheckingDone">CBRE Checking Done</label>
                                    <select id="cbreCheckingDone" onchange="toggleCBRECheckingDate()">
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                </div>
                                <div class="form-group" id="cbreCheckingDateContainer" style="display: none;">
                                    <label for="cbreCheckingDate">CBRE Checking Date</label>
                                    <input type="date" id="cbreCheckingDate">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="moveToCRMFromThirdParty()">
                                    <i class="fas fa-arrow-right"></i> Move to CRM
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerRemarks">Customer Remarks</label>
                        <textarea id="customerRemarks" rows="3" placeholder="Feedback from customer..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="crmNoc">CRM NOC Received</label>
                        <select id="crmNoc">
                            <option value="pending">Pending</option>
                            <option value="received">Received</option>
                            <option value="not_required">Not Required</option>
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveFirstVisit()">
                            <i class="fas fa-save"></i> Save Visit Details
                        </button>
                        <button class="btn btn-secondary" onclick="resetVisitForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HANDOVER TAB -->
        <div id="handover-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-handshake"></i>
                    HOTO Handover Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('handover', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('handover', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('handover', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="handover-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="handover-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Handover Form -->
                <div id="handover-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('handover')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-house-user"></i>
                        Handover Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="handoverFlat">Flat Number *</label>
                            <input type="text" id="handoverFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="handoverTower">Tower *</label>
                            <input type="text" id="handoverTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Customer Name *</label>
                            <input type="text" id="customerName" placeholder="Full name of customer">
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Customer Email *</label>
                            <input type="email" id="customerEmail" placeholder="customer@email.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secondOwnerName">Second Owner (if any)</label>
                            <input type="text" id="secondOwnerName" placeholder="Full name of second owner">
                        </div>
                        <div class="form-group">
                            <label for="secondOwnerEmail">Second Owner Email</label>
                            <input type="email" id="secondOwnerEmail" placeholder="secondowner@email.com">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hotoMember">HOTO Team Member *</label>
                            <input type="text" id="hotoMember" placeholder="Name of HOTO team member">
                        </div>
                        <div class="form-group">
                            <label for="handoverDateTime">Handover Date & Time *</label>
                            <input type="datetime-local" id="handoverDateTime">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemsHanded">Items Handed Over</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemKeys" value="keys">
                                <label for="itemKeys">All Keys</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemManual" value="manual">
                                <label for="itemManual">User Manual</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="itemGift" value="gift">
                                <label for="itemGift">Welcome Gift</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerFeedback">Customer Feedback</label>
                        <textarea id="customerFeedback" rows="3" placeholder="Customer comments and feedback..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="finalInspection">Final Inspection Completed</label>
                        <select id="finalInspection" onchange="toggleInspectionRemarks()">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="partial">Partial</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="inspectionRemarksContainer" style="display: none;">
                        <label for="inspectionRemarks">Inspection Remarks</label>
                        <textarea id="inspectionRemarks" rows="2" placeholder="Remarks about final inspection..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveHandover()">
                            <i class="fas fa-save"></i> Save Handover
                        </button>
                        <button class="btn btn-secondary" onclick="resetHandoverForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INTERIORS TAB -->
        <div id="interiors-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-hammer"></i>
                    Interiors Work Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('interiors', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('interiors', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('interiors', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="interiors-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="interiors-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Interiors Form -->
                <div id="interiors-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('interiors')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-paint-roller"></i>
                        Interiors Work Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="interiorsFlat">Flat Number *</label>
                            <input type="text" id="interiorsFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="interiorsTower">Tower *</label>
                            <input type="text" id="interiorsTower" readonly>
                        </div>
                    </div>
                    
                    <!-- REORDERED: Site Supervisor First -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="siteSupervisor">Site Supervisor Name</label>
                            <input type="text" id="siteSupervisor" placeholder="Name of site supervisor">
                        </div>
                        <div class="form-group">
                            <label for="siteSupervisorNumber">Site Supervisor Number *</label>
                            <input type="tel" id="siteSupervisorNumber" placeholder="Supervisor phone number">
                        </div>
                    </div>
                    
                    <!-- Main Vendor Form -->
                    <div id="mainVendorForm">
                        <h4 class="section-title">
                            <i class="fas fa-industry"></i>
                            Main Vendor Details
                        </h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contractorName">Contractor Name *</label>
                                <input type="text" id="contractorName" placeholder="Name of interior contractor">
                            </div>
                            <div class="form-group">
                                <label for="contractorContact">Contractor Contact *</label>
                                <input type="tel" id="contractorContact" placeholder="Contractor phone number">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="workStartDate">Work Start Date *</label>
                                <input type="date" id="workStartDate">
                            </div>
                            <div class="form-group">
                                <label for="estimatedEndDate">Estimated End Date</label>
                                <input type="date" id="estimatedEndDate">
                            </div>
                        </div>
                        
                        <!-- Interior Works Planned -->
                        <div class="form-group">
                            <label>Interior Works Planned</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workFlooring" value="flooring">
                                    <label for="workFlooring">Flooring</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workPainting" value="painting">
                                    <label for="workPainting">Painting</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workElectrical" value="electrical">
                                    <label for="workElectrical">Electrical Fittings</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workPlumbing" value="plumbing">
                                    <label for="workPlumbing">Plumbing Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workCarpentry" value="carpentry">
                                    <label for="workCarpentry">Carpentry</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workFalseCeiling" value="false_ceiling">
                                    <label for="workFalseCeiling">False Ceiling</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workKitchen" value="kitchen">
                                    <label for="workKitchen">Kitchen Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="workWardrobe" value="wardrobe">
                                    <label for="workWardrobe">Wardrobe</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- DOS and DON'Ts Checkbox -->
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="dosDontsExplained">
                                <label for="dosDontsExplained"><strong>DOS and DON'Ts Explained to Contractor</strong></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MOVED: Multiple Vendors Option Below Interior Works -->
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="multipleVendors" onchange="toggleMultipleVendors()">
                            <label for="multipleVendors"><strong>Multiple Vendors (This will disable previous vendor details)</strong></label>
                        </div>
                    </div>
                    
                    <!-- Additional Vendors Container -->
                    <div id="additionalVendorsContainer" class="vendor-form hidden">
                        <div class="vendor-header">
                            <h4><i class="fas fa-plus-circle"></i> Additional Vendor</h4>
                            <button type="button" class="remove-vendor" onclick="removeVendor(this)">Remove</button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="additionalContractorName">Contractor Name *</label>
                                <input type="text" class="additional-contractor-name" placeholder="Name of additional contractor">
                            </div>
                            <div class="form-group">
                                <label for="additionalContractorContact">Contractor Contact *</label>
                                <input type="tel" class="additional-contractor-contact" placeholder="Additional contractor phone">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Interior Works Planned by this Vendor</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-flooring" value="flooring">
                                    <label>Flooring</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-painting" value="painting">
                                    <label>Painting</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-electrical" value="electrical">
                                    <label>Electrical Fittings</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-plumbing" value="plumbing">
                                    <label>Plumbing Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-carpentry" value="carpentry">
                                    <label>Carpentry</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-false-ceiling" value="false_ceiling">
                                    <label>False Ceiling</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-kitchen" value="kitchen">
                                    <label>Kitchen Work</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="additional-work-wardrobe" value="wardrobe">
                                    <label>Wardrobe</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" class="additional-dos-donts-explained">
                                <label><strong>DOS and DON'Ts Explained to this Contractor</strong></label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="additionalStartDate">Work Start Date *</label>
                                <input type="date" class="additional-start-date">
                            </div>
                            <div class="form-group">
                                <label for="additionalEndDate">Estimated End Date</label>
                                <input type="date" class="additional-end-date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-info" onclick="addAdditionalVendor()" id="addVendorBtn" style="display: none;">
                            <i class="fas fa-plus"></i> Add Another Vendor
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="interiorsRemarks">Remarks / Notes</label>
                        <textarea id="interiorsRemarks" rows="3" placeholder="Additional notes about interior work..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveInteriors()">
                            <i class="fas fa-save"></i> Save Interiors Work
                        </button>
                        <button class="btn btn-warning" onclick="openDeviationForm('interiors')">
                            <i class="fas fa-exclamation-triangle"></i> Record Deviation
                        </button>
                        <button class="btn btn-secondary" onclick="resetInteriorsForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MOVE-IN TAB -->
        <div id="move-in-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-home"></i>
                    Customer Move-in Process
                </h2>
                
                <!-- Tower Selection -->
                <div class="tower-selector">
                    <button class="tower-btn active" onclick="selectTower('move-in', 'A')">Tower A</button>
                    <button class="tower-btn" onclick="selectTower('move-in', 'B')">Tower B</button>
                    <button class="tower-btn" onclick="selectTower('move-in', 'C')">Tower C</button>
                </div>
                
                <!-- Floor Selection -->
                <div class="floor-selection">
                    <label>Select Floor:</label>
                    <div class="floor-buttons" id="move-in-floor-buttons">
                        <!-- Floor buttons dynamically loaded -->
                    </div>
                </div>
                
                <!-- Flat Selection -->
                <div class="flat-grid" id="move-in-flat-grid">
                    <!-- Flats dynamically loaded -->
                </div>
                
                <!-- Move-in Form -->
                <div id="move-in-form-container" style="display: none;">
                    <div class="button-group" style="margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="loadExistingData('movein')">
                            <i class="fas fa-edit"></i> Edit Existing Data
                        </button>
                    </div>
                    
                    <h3 class="section-title">
                        <i class="fas fa-truck-moving"></i>
                        Move-in Details
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveInFlat">Flat Number *</label>
                            <input type="text" id="moveInFlat" readonly>
                        </div>
                        <div class="form-group">
                            <label for="moveInTower">Tower *</label>
                            <input type="text" id="moveInTower" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveinCustomerName">Customer Name *</label>
                            <input type="text" id="moveinCustomerName" placeholder="Full name of customer moving in">
                        </div>
                        <div class="form-group">
                            <label for="moveinContact">Contact Number *</label>
                            <input type="tel" id="moveinContact" placeholder="Customer contact number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="moveinDate">Move-in Date *</label>
                            <input type="date" id="moveinDate">
                        </div>
                        <div class="form-group">
                            <label for="moveinTime">Move-in Time *</label>
                            <select id="moveinTime">
                                <option value="morning">Morning (8 AM - 12 PM)</option>
                                <option value="afternoon">Afternoon (12 PM - 4 PM)</option>
                                <option value="evening">Evening (4 PM - 8 PM)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="moveClearanceGiven" onchange="toggleMoveinSave()">
                            <label for="moveClearanceGiven"><strong>Move clearance given by fire and safety team</strong></label>
                        </div>
                    </div>
                    
                    <!-- Deviations Section -->
                    <div id="deviationsSection" style="display: none;">
                        <h4 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Recorded Deviations (From Interiors)
                        </h4>
                        <div id="deviationsList">
                            <!-- Deviations will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="moveinRemarks">Move-in Remarks</label>
                        <textarea id="moveinRemarks" rows="3" placeholder="Any special requirements or remarks..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveMoveIn()" id="saveMoveinBtn" disabled>
                            <i class="fas fa-save"></i> Save Move-in Details
                        </button>
                        <button class="btn btn-warning" onclick="openDeviationForm('movein')">
                            <i class="fas fa-exclamation-triangle"></i> Record Deviation
                        </button>
                        <button class="btn btn-secondary" onclick="resetMoveInForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EXCEL PROCESSOR TAB -->
        <div id="excel-processor-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-file-excel"></i>
                    Excel Data Processor
                </h2>
                
                <div class="setup-step">
                    <h3><i class="fas fa-upload"></i> Step 1: Upload Excel File</h3>
                    <div class="setup-instruction">
                        <p><strong>Supported Formats:</strong> .xlsx, .xls, .csv</p>
                        <p><strong>Requirements:</strong> File should have columns matching the template format</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <select id="templateSelect" class="btn" style="flex: 1; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;" onchange="selectTemplate()">
                                <option value="">Select Template Type</option>
                                <option value="key_handover">Key Handover Template</option>
                                <option value="snagging">CBRE Snagging Template</option>
                                <option value="first_visit">First Visit Template</option>
                                <option value="handover">Handover Template</option>
                                <option value="interiors">Interiors Template</option>
                                <option value="movein">Move-in Template</option>
                                <option value="project_mep">Project/MEP Template</option>
                                <option value="crm">CRM Template</option>
                            </select>
                            <button class="btn btn-warning" onclick="downloadSelectedTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                        </div>
                        
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        <div id="dropZone" style="border: 2px dashed #1F3765; border-radius: 8px; padding: 40px; text-align: center; background: #f8fafc; cursor: pointer;" 
                             onclick="document.getElementById('excelFileInput').click()" 
                             ondrop="handleFileDrop(event)" 
                             ondragover="handleDragOver(event)">
                            <i class="fas fa-cloud-upload-alt fa-3x" style="color: #1F3765; margin-bottom: 15px;"></i>
                            <h4>Drag & Drop Excel File Here</h4>
                            <p>or click to browse</p>
                            <p id="selectedFileName" style="margin-top: 15px; color: #666;"></p>
                        </div>
                    </div>
                    
                    <div id="filePreview" style="display: none;">
                        <h4><i class="fas fa-table"></i> File Preview (First 10 rows)</h4>
                        <div id="previewTable" style="overflow: auto; max-height: 300px; margin: 15px 0;"></div>
                    </div>
                    
                    <!-- Error messages container -->
                    <div id="validationErrors" style="display: none;">
                        <h4><i class="fas fa-exclamation-triangle"></i> Validation Errors</h4>
                        <div id="errorList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <div class="setup-step">
                    <h3><i class="fas fa-cog"></i> Step 2: Configure Import</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="importProcess">Select Process to Import *</label>
                            <select id="importProcess">
                                <option value="">Select Process</option>
                                <option value="key_handover">Key Handover</option>
                                <option value="snagging">CBRE Snagging</option>
                                <option value="first_visit">First Visit</option>
                                <option value="handover">Handover</option>
                                <option value="interiors">Interiors</option>
                                <option value="movein">Move-in</option>
                                <option value="project_mep">Project/MEP</option>
                                <option value="crm">CRM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importAction">Import Action *</label>
                            <select id="importAction">
                                <option value="append">Append to Existing Data</option>
                                <option value="replace">Replace All Data</option>
                                <option value="update">Update Existing Records</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="previewImport()">
                            <i class="fas fa-eye"></i> Preview Import
                        </button>
                        <button class="btn btn-primary" onclick="processImport()" id="processImportBtn">
                            <i class="fas fa-play"></i> Process Import
                        </button>
                    </div>
                    
                    <!-- Import Summary -->
                    <div id="importSummary" class="import-summary" style="display: none;">
                        <h4><i class="fas fa-info-circle"></i> Import Summary</h4>
                        <p id="summaryText">Loading summary...</p>
                    </div>
                </div>
                
                <div class="setup-step">
                    <h3><i class="fas fa-download"></i> Step 3: Export Options</h3>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="exportAllToExcel()">
                            <i class="fas fa-file-excel"></i> Export All Data to Excel
                        </button>
                        <button class="btn btn-accent" onclick="exportSelectedProcess()">
                            <i class="fas fa-filter"></i> Export Selected Process
                        </button>
                        <button class="btn btn-primary" onclick="exportToGoogleSheets()" id="exportGoogleSheetsBtn">
                            <i class="fab fa-google"></i> Export to Google Sheets
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INTEGRATION TAB -->
        <div id="integration-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-plug"></i>
                    Google Sheets Integration Setup
                </h2>
                
                <!-- Connection Status -->
                <div class="setup-step">
                    <h3><i class="fas fa-link"></i> Connection Status</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current Status:</label>
                            <div id="connectionStatus" class="status-badge status-connected">
                                <i class="fas fa-check-circle"></i> Connected
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Last Sync:</label>
                            <div id="lastSyncTime">Never</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Local Records:</label>
                            <div id="localRecordsCount">Calculating...</div>
                        </div>
                        <div class="form-group">
                            <label>Cloud Records:</label>
                            <div id="cloudRecordsCount">Not connected</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Google Sheet Setup -->
                <div class="setup-step">
                    <h3><i class="fas fa-cogs"></i> Step 1: Configure Google Sheet</h3>
                    
                    <div class="template-instructions">
                        <h4><i class="fas fa-exclamation-triangle"></i> IMPORTANT: Your Google Sheet MUST have these sheets:</h4>
                        <div class="required-fields">
                            <div class="required-field">
                                <span class="field-name">key_handover</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">snagging</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">first_visit</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">handover</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">interiors</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">movein</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">project_mep</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                            <div class="required-field">
                                <span class="field-name">crm</span>
                                <span class="field-type">(Sheet name exactly as shown)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setup-instruction">
                        <h4><i class="fas fa-download"></i> Create Template</h4>
                        <p>Create a new Google Sheet with the required sheets or use our template:</p>
                        <button class="btn btn-primary" onclick="createGoogleSheetTemplate()">
                            <i class="fab fa-google"></i> Open Google Sheets Template
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSheetTemplate()">
                            <i class="fas fa-download"></i> Download Excel Template
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Web App Deployment -->
                <div class="setup-step">
                    <h3><i class="fas fa-code"></i> Step 2: Deploy Google Apps Script</h3>
                    
                    <div class="setup-instruction">
                        <p><strong>Follow these steps:</strong></p>
                        <ol>
                            <li>Open your Google Sheet</li>
                            <li>Click <strong>Extensions ‚Üí Apps Script</strong></li>
                            <li>Delete any existing code</li>
                            <li>Copy and paste the code from the box below</li>
                            <li>Click <strong>Save</strong> (Ctrl+S)</li>
                            <li>Click <strong>Deploy ‚Üí New Deployment</strong></li>
                            <li>Select <strong>Web App</strong> as type</li>
                            <li>Set "Execute as" to <strong>Me</strong></li>
                            <li>Set "Who has access" to <strong>Anyone</strong></li>
                            <li>Click <strong>Deploy</strong></li>
                            <li>Copy the Web App URL provided</li>
                        </ol>
                    </div>
                    
                    <div class="form-group">
                        <label for="webAppCode">Google Apps Script Code:</label>
                        <textarea id="webAppCode" rows="15" readonly style="font-family: monospace; background: #f8f9fa; padding: 15px;">
// Google Apps Script for HOTO Process Tracker
const SHEET_NAMES = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const action = e.parameter.action;
    const process = e.parameter.process;
    const content = e.postData ? JSON.parse(e.postData.contents) : {};
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Handle CORS
    const response = ContentService.createTextOutput();
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    
    let data;
    
    switch(action) {
      case 'get_data':
        data = getData(ss, process);
        break;
      case 'save_data':
        data = saveData(ss, process, content.data);
        break;
      case 'get_all_data':
        data = getAllData(ss);
        break;
      case 'sync_all':
        data = syncAllData(ss, content.data);
        break;
      case 'ping':
        data = {status: 'online', timestamp: new Date().toISOString()};
        break;
      case 'get_stats':
        data = getStatistics(ss);
        break;
      default:
        data = {error: 'Invalid action'};
    }
    
    response.setContent(JSON.stringify(data));
    return response;
    
  } catch (error) {
    const response = ContentService.createTextOutput(JSON.stringify({error: error.toString()}));
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    return response;
  }
}

function getData(ss, process) {
  if (!SHEET_NAMES.includes(process)) {
    return {error: 'Invalid process name', data: []};
  }
  
  const sheet = ss.getSheetByName(process);
  if (!sheet) {
    return {data: [], count: 0, message: `Sheet ${process} not found`};
  }
  
  const data = getSheetData(sheet);
  return {data: data, count: data.length};
}

function getAllData(ss) {
  const allData = {};
  SHEET_NAMES.forEach(process => {
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      allData[process] = getSheetData(sheet);
    } else {
      allData[process] = [];
    }
  });
  
  return allData;
}

function saveData(ss, process, rowData) {
  if (!SHEET_NAMES.includes(process)) {
    return {error: 'Invalid process name'};
  }
  
  let sheet = ss.getSheetByName(process);
  if (!sheet) {
    sheet = ss.insertSheet(process);
    const headers = getHeadersForProcess(process);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }
  
  const data = getSheetData(sheet);
  const existingIndex = data.findIndex(row => 
    row.tower === rowData.tower && row.flat === rowData.flat);
  
  if (existingIndex >= 0) {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const rowNum = existingIndex + 2;
    headers.forEach((header, col) => {
      if (rowData[header] !== undefined) {
        sheet.getRange(rowNum, col + 1).setValue(rowData[header]);
      }
    });
    return {message: 'Record updated', action: 'update', record: rowData};
  } else {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const newRow = headers.map(header => rowData[header] || '');
    sheet.appendRow(newRow);
    return {message: 'Record added', action: 'add', record: rowData};
  }
}

function syncAllData(ss, allData) {
  const results = {};
  
  SHEET_NAMES.forEach(process => {
    if (allData[process]) {
      let sheet = ss.getSheetByName(process);
      if (!sheet) {
        sheet = ss.insertSheet(process);
        const headers = getHeadersForProcess(process);
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      }
      
      sheet.clear();
      const headers = getHeadersForProcess(process);
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      allData[process].forEach(row => {
        const rowData = headers.map(header => row[header] || '');
        sheet.appendRow(rowData);
      });
      
      results[process] = {
        added: allData[process].length,
        updated: 0,
        total: allData[process].length
      };
    }
  });
  
  return results;
}

function getSheetData(sheet) {
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return [];
  
  const headers = data[0];
  const rows = data.slice(1);
  
  return rows.map(row => {
    const obj = {};
    headers.forEach((header, index) => {
      obj[header] = row[index] !== undefined ? row[index] : '';
    });
    return obj;
  });
}

function getHeadersForProcess(process) {
  const headers = {
    key_handover: ['tower', 'flat', 'handover_person', 'received_by_cbre', 'handover_date', 'all_keys_not_handed', 'remarks', 'timestamp'],
    snagging: ['tower', 'flat', 'mep_inspector', 'mep_start_date', 'mep_end_date', 'mep_completed', 'civil_inspector', 'civil_start_date', 'civil_end_date', 'civil_completed', 'electrical_inspector', 'electrical_start_date', 'electrical_end_date', 'electrical_completed', 'water_inspector', 'water_start_date', 'water_end_date', 'water_completed', 'ac_drain_inspector', 'ac_drain_start_date', 'ac_drain_end_date', 'ac_drain_completed', 'tiles_inspector', 'tiles_start_date', 'tiles_end_date', 'tiles_completed', 'remarks', 'followup_date', 'timestamp'],
    first_visit: ['tower', 'flat', 'owner_name', 'owner_phone', 'visit_date', 'hot_member', 'handover_suggested', 'owner_will_inform', 'going_for_third_party', 'third_party_date_confirmed', 'report_received_date', 'soft_copy', 'hard_copy', 'informed_to_project_team', 'project_team_informed_date', 'cbre_checking_done', 'cbre_checking_date', 'customer_remarks', 'crm_noc', 'timestamp'],
    handover: ['tower', 'flat', 'customer_name', 'customer_email', 'second_owner_name', 'second_owner_email', 'hoto_member', 'handover_date', 'items_handed', 'customer_feedback', 'final_inspection', 'inspection_remarks', 'timestamp'],
    interiors: ['tower', 'flat', 'contractor_name', 'contractor_contact', 'work_start_date', 'estimated_end_date', 'site_supervisor_number', 'site_supervisor', 'interior_works', 'dos_donts_explained', 'multiple_vendors', 'additional_vendors', 'remarks', 'timestamp'],
    movein: ['tower', 'flat', 'customer_name', 'contact_number', 'movein_date', 'movein_time', 'move_clearance_given', 'deviations_resolved', 'movein_remarks', 'timestamp'],
    project_mep: ['tower', 'flat', 'snags_status', 'confirmation_date', 'cbre_checked', 'cbre_checked_date', 'timestamp'],
    crm: ['tower', 'flat', 'description', 'informed_to', 'status', 'followup_date', 'remarks', 'timestamp']
  };
  
  return headers[process] || [];
}

function getStatistics(ss) {
  const stats = {};
  let total = 0;
  
  SHEET_NAMES.forEach(process => {
    const sheet = ss.getSheetByName(process);
    if (sheet) {
      const count = Math.max(0, sheet.getLastRow() - 1);
      stats[process] = count;
      total += count;
    } else {
      stats[process] = 0;
    }
  });
  
  stats.total = total;
  return stats;
}
                        </textarea>
                        <button class="btn btn-secondary" onclick="copyToClipboard('webAppCode')">
                            <i class="fas fa-copy"></i> Copy Code to Clipboard
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Connect -->
                <div class="setup-step">
                    <h3><i class="fas fa-wifi"></i> Step 3: Connect to Web App</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="webAppUrl">Web App URL *</label>
                            <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec" style="font-family: monospace;">
                            <small style="color: #666;">Paste the Web App URL from deployment</small>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" onclick="testConnection()" style="margin-top: 8px;">
                                <i class="fas fa-check"></i> Test Connection
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sync Options</label>
                            <select id="syncMode" class="btn" style="width: 100%;">
                                <option value="auto">Auto-sync (on save)</option>
                                <option value="manual">Manual sync only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sync Frequency</label>
                            <select id="syncFrequency" class="btn" style="width: 100%;">
                                <option value="immediate">Immediate</option>
                                <option value="5min">Every 5 minutes</option>
                                <option value="15min">Every 15 minutes</option>
                                <option value="hourly">Every hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="saveConnection()">
                            <i class="fas fa-save"></i> Save Connection
                        </button>
                        <button class="btn btn-accent" onclick="syncToGoogleSheets()" id="syncButton">
                            <i class="fas fa-sync-alt"></i> Sync to Google Sheets
                        </button>
                        <button class="btn btn-secondary" onclick="loadFromGoogleSheets()" id="loadButton">
                            <i class="fas fa-download"></i> Load from Google Sheets
                        </button>
                        <button class="btn btn-danger" onclick="disconnectGoogleSheets()">
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Sync Status -->
                <div class="setup-step">
                    <h3><i class="fas fa-chart-bar"></i> Step 4: Sync Status & Statistics</h3>
                    
                    <div class="progress-container" style="margin-top: 20px;">
                        <div class="progress-label">
                            <span>Sync Progress</span>
                            <span id="syncProgressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="syncProgressBar" style="width: 0%; background-color: #3E7CA6;"></div>
                        </div>
                    </div>
                    
                    <div id="syncDetails" style="margin-top: 20px; display: none;">
                        <h4><i class="fas fa-info-circle"></i> Sync Details</h4>
                        <div id="syncDetailsContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW ANALYTICS TAB -->
        <div id="analytics-tab" class="tab-content">
            <div class="process-form">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Analytics & Reports
                </h2>
                
                <!-- Date Range Filter -->
                <div class="analytics-controls">
                    <h3><i class="fas fa-filter"></i> Filter Data</h3>
                    
                    <div class="date-range-filter">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="applyDateFilter()" style="margin-top: 8px;">
                                <i class="fas fa-check"></i> Apply Filter
                            </button>
                        </div>
                    </div>
                    
                    <div class="quick-filter-buttons">
                        <button class="quick-filter-btn active" onclick="applyQuickFilter('7days')">Last 7 Days</button>
                        <button class="quick-filter-btn" onclick="applyQuickFilter('30days')">Last 30 Days</button>
                        <button class="quick-filter-btn" onclick="applyQuickFilter('90days')">Last 90 Days</button>
                        <button class="quick-filter-btn" onclick="applyQuickFilter('365days')">Last 365 Days</button>
                        <button class="quick-filter-btn" onclick="applyQuickFilter('all')">All Time</button>
                    </div>
                </div>
                
                <!-- Filtered KPI Cards -->
                <div class="kpi-grid" id="filtered-kpi-cards">
                    <!-- Filtered KPI cards will be dynamically loaded here -->
                </div>
                
                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Monthly Trends Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i> Monthly Trends
                            </div>
                            <button class="report-btn" onclick="downloadMonthlyTrendsReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="canvas-container">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Tower Performance Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-building"></i> Tower Performance
                            </div>
                            <button class="report-btn" onclick="downloadTowerPerformanceReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="canvas-container">
                            <canvas id="towerPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Snagging Status Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-search"></i> Snagging Status
                            </div>
                            <button class="report-btn" onclick="downloadSnaggingReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="canvas-container">
                            <canvas id="snaggingStatusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Weekly Performance Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-calendar-week"></i> Weekly Performance (4 Weeks)
                            </div>
                            <button class="report-btn" onclick="downloadWeeklyPerformanceReport()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="canvas-container">
                            <canvas id="weeklyPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Report Actions -->
                <div class="analytics-controls">
                    <h3><i class="fas fa-file-excel"></i> Download Reports</h3>
                    
                    <div class="report-actions">
                        <button class="report-btn" onclick="downloadPendingKeysReport()">
                            <i class="fas fa-key"></i> Pending Keys Report
                        </button>
                        <button class="report-btn" onclick="downloadSnaggingAnalyticsReport()">
                            <i class="fas fa-search"></i> Snagging Analytics
                        </button>
                        <button class="report-btn" onclick="downloadProductivityReport()">
                            <i class="fas fa-chart-bar"></i> Productivity Report
                        </button>
                        <button class="report-btn" onclick="downloadTrendAnalysisReport()">
                            <i class="fas fa-chart-line"></i> Trend Analysis
                        </button>
                        <button class="report-btn" onclick="downloadAlertSummaryReport()">
                            <i class="fas fa-exclamation-triangle"></i> Alert Summary
                        </button>
                        <button class="report-btn" onclick="downloadAllReports()">
                            <i class="fas fa-file-archive"></i> All Reports (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        <!-- Details Modal -->
        <div id="detailsModal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('detailsModal')">&times;</button>
                <h2 class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Complete Flat Details
                </h2>
                <div id="modalContent"></div>
            </div>
        </div>
        
        <!-- Deviation Modal -->
        <div id="deviationModal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('deviationModal')">&times;</button>
                <h2 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Record Deviation
                </h2>
                <div class="form-group">
                    <label for="deviationVisitDate">Visit Date *</label>
                    <input type="date" id="deviationVisitDate">
                </div>
                <div class="form-group">
                    <label for="deviationType">Type of Deviation *</label>
                    <select id="deviationType">
                        <option value="fire_safety">Fire Safety</option>
                        <option value="structural">Structural</option>
                        <option value="electrical">Electrical</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="finishing">Finishing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deviationDetails">Deviation Details *</label>
                    <textarea id="deviationDetails" rows="4" placeholder="Detailed description of the deviation..."></textarea>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveDeviation()">
                        <i class="fas fa-save"></i> Save Deviation
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('deviationModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <footer class="site-footer">
            <p>HOTO Process Tracker | High Rise Building Complex | Towers A, B & C | Total 939 Apartments (313 per tower)</p>
            <div class="data-info" id="dataSourceInfo">
                <i class="fas fa-database"></i>
                <span id="dataSourceText">Data stored locally. Connect to Google Sheets for cloud storage.</span>
            </div>
        </footer>
    </div>

    <script>
        // ===== APP STATE =====
        let APP_CONFIG = {
            googleSheetId: null,
            webAppUrl: null,
            syncMode: 'auto',
            syncFrequency: 'immediate',
            isConnected: false,
            lastSync: null,
            syncInProgress: false,
            syncInterval: null
        };
        
        let currentProcess = '';
        let currentTower = 'A';
        let currentFloor = '1';
        let excelFileData = null;
        let selectedTemplate = '';
        let excelWorkbook = null;
        let currentFlatForDeviation = null;
        let isEditingMode = false;
        let currentEditingProcess = '';
        
        // ===== BUILDING CONFIGURATION =====
        const BUILDING_CONFIG = {
            towers: ['A', 'B', 'C'],
            floorsPerTower: 35,
            flatsPerFloor: 9,
            totalFlatsPerTower: 315,
            totalFlatsOverall: 945,
            countableFlatsPerTower: 313,
            countableFlatsOverall: 939,
            refugeFlats: {
                '18': [1806],
                '28': [2806]
            }
        };
        
        // ===== ANALYTICS STATE =====
        let analyticsFilter = {
            startDate: null,
            endDate: null,
            filterType: 'all'
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            
            // Load saved configuration
            loadConfig();
            
            // Initialize floor buttons for all tabs
            initializeFloorButtons();
            
            // Set default dates
            setDefaultDates();
            
            // Initialize tower progress charts
            initializeTowerCharts();
            
            // Initialize dashboard
            updateDashboardCounts();
            
            // Set up file input listener
            document.getElementById('excelFileInput').addEventListener('change', handleFileSelect);
            
            // Initialize form events
            initializeFormEvents();
            
            // Update connection status
            updateConnectionStatus();
            
            // Update local record counts
            updateLocalRecordCounts();
            
            // Start sync interval if needed
            startSyncInterval();
            
            // Initialize analytics
            initializeAnalytics();
            
            // AUTOMATICALLY CONNECT TO GOOGLE SHEETS ON LOAD
            autoConnectToGoogleSheets();
        });
        
        // NEW FUNCTION: Auto-connect to Google Sheets
        function autoConnectToGoogleSheets() {
            // Try to load the Google Sheets URL from a config file or default URL
            const defaultWebAppUrl = 'https://script.google.com/macros/s/AKfycbx2Ojx8HLwK38rFtiI6_bJ3p_yR5WAB1cSSUzYHKrC6i_G3gMYNQ8IqrdYJvT1rH5RQ/exec';
            
            // Set the URL in the input field
            document.getElementById('webAppUrl').value = defaultWebAppUrl;
            APP_CONFIG.webAppUrl = defaultWebAppUrl;
            APP_CONFIG.isConnected = true;
            APP_CONFIG.syncMode = 'auto';
            
            // Update UI to show connected
            updateConnectionStatus();
            
            // Load data from Google Sheets
            loadFromGoogleSheets();
            
            // Show notification
            showNotification('Automatically connected to shared Google Sheets data', 'success');
        }
        
        function loadConfig() {
            const savedConfig = localStorage.getItem('hotoConfig');
            if (savedConfig) {
                APP_CONFIG = JSON.parse(savedConfig);
                
                if (APP_CONFIG.webAppUrl) {
                    document.getElementById('webAppUrl').value = APP_CONFIG.webAppUrl;
                }
                if (APP_CONFIG.syncMode) {
                    document.getElementById('syncMode').value = APP_CONFIG.syncMode;
                }
                if (APP_CONFIG.syncFrequency) {
                    document.getElementById('syncFrequency').value = APP_CONFIG.syncFrequency;
                }
            }
        }
        
        function saveConfig() {
            localStorage.setItem('hotoConfig', JSON.stringify(APP_CONFIG));
        }
        
        // ===== TOWER SELECTION FUNCTION =====
        function selectTower(processType, tower) {
            // Update tower button states
            const tabId = `${processType}-tab`;
            const buttons = document.querySelectorAll(`#${tabId} .tower-btn`);
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the clicked button
            const clickedButton = event.target;
            clickedButton.classList.add('active');
            
            currentTower = tower;
            
            // Load floors for the selected tower
            loadFloors(processType, tower);
        }
        
        // ===== FLOOR AND FLAT FUNCTIONS =====
        function initializeFloorButtons() {
            const processes = ['key-handover', 'snagging', 'first-visit', 'handover', 'interiors', 'move-in', 'project-mep', 'crm'];
            processes.forEach(process => {
                loadFloors(process, 'A');
            });
        }
        
        function loadFloors(processType, tower) {
            // Use the correct ID pattern: processType with hyphens replaced by dashes + '-floor-buttons'
            const floorButtonsId = `${processType}-floor-buttons`;
            const floorButtonsContainer = document.getElementById(floorButtonsId);
            
            if (!floorButtonsContainer) {
                console.error(`Floor buttons container not found: ${floorButtonsId}`);
                return;
            }
            
            floorButtonsContainer.innerHTML = '';
            
            for (let floor = 1; floor <= BUILDING_CONFIG.floorsPerTower; floor++) {
                const floorBtn = document.createElement('button');
                floorBtn.className = 'floor-btn';
                if (floor === 1) floorBtn.classList.add('active');
                floorBtn.textContent = floor;
                floorBtn.onclick = function() {
                    selectFloor(processType, floor.toString(), tower);
                };
                floorButtonsContainer.appendChild(floorBtn);
            }
            
            loadFlats(processType, tower, '1');
        }
        
        function selectFloor(processType, floor, tower) {
            const tabId = `${processType}-tab`;
            const buttons = document.querySelectorAll(`#${tabId} .floor-btn`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentFloor = floor;
            loadFlats(processType, tower, floor);
        }
        
        function loadFlats(processType, tower, floor) {
            const flatGridId = `${processType}-flat-grid`;
            const flatGridContainer = document.getElementById(flatGridId);
            const formContainer = document.getElementById(`${processType}-form-container`);
            
            if (!flatGridContainer) {
                console.error(`Flat grid container not found: ${flatGridId}`);
                return;
            }
            
            flatGridContainer.innerHTML = '';
            if (formContainer) formContainer.style.display = 'none';
            
            for (let unit = 1; unit <= BUILDING_CONFIG.flatsPerFloor; unit++) {
                const flatBtn = document.createElement('div');
                flatBtn.className = 'flat-item';
                
                const flatNumber = `${parseInt(floor)}${unit.toString().padStart(2, '0')}`;
                flatBtn.textContent = flatNumber;
                flatBtn.dataset.flat = flatNumber;
                flatBtn.dataset.tower = tower;
                
                if (isRefugeFlat(flatNumber)) {
                    flatBtn.classList.add('refuge');
                    const refugeIndicator = document.createElement('div');
                    refugeIndicator.className = 'refuge-indicator';
                    refugeIndicator.textContent = 'R';
                    flatBtn.appendChild(refugeIndicator);
                    flatBtn.title = 'Refuge Area Flat - Not Countable in Progress';
                }
                
                flatBtn.onclick = function() {
                    selectFlat(processType, tower, flatNumber);
                };
                flatGridContainer.appendChild(flatBtn);
            }
        }
        
        function selectFlat(processType, tower, flatNumber) {
            const tabId = `${processType}-tab`;
            const buttons = document.querySelectorAll(`#${tabId} .flat-item`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            const formContainer = document.getElementById(`${processType}-form-container`);
            if (!formContainer) {
                console.error(`Form container not found: ${processType}-form-container`);
                return;
            }
            
            // Set basic fields - using the correct element IDs
            const flatFieldId = getFlatFieldId(processType);
            const towerFieldId = getTowerFieldId(processType);
            
            const flatField = document.getElementById(flatFieldId);
            const towerField = document.getElementById(towerFieldId);
            
            if (flatField) flatField.value = flatNumber;
            if (towerField) towerField.value = tower;
            
            // Update CRM datetime display
            if (processType === 'crm') {
                updateCRMDateTimeDisplay(tower, flatNumber);
            }
            
            // Show the form container
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Load deviations for move-in tab
            if (processType === 'move-in') {
                loadDeviationsForMoveIn(tower, flatNumber);
            }
            
            // Load existing data for this flat - NOW FROM GOOGLE SHEETS
            loadExistingDataForFlat(processType, tower, flatNumber);
            
            if (isRefugeFlat(flatNumber)) {
                showNotification(`Selected Refuge Area Flat ${flatNumber} in Tower ${tower} (Not countable in progress)`, 'warning');
            }
        }
        
        // MODIFIED FUNCTION: Now loads from Google Sheets first, then local
        function loadExistingDataForFlat(processType, tower, flatNumber) {
            const processKey = getProcessKey(processType);
            if (!processKey) return;
            
            // First try to load from Google Sheets if connected
            if (APP_CONFIG.isConnected && APP_CONFIG.webAppUrl) {
                loadFlatDataFromGoogleSheets(processKey, tower, flatNumber, processType);
            } else {
                // Fall back to local storage
                loadFromLocalStorage(processKey, tower, flatNumber, processType);
            }
        }
        
        function loadFlatDataFromGoogleSheets(processKey, tower, flatNumber, processType) {
            // Use JSONP to fetch data for this specific flat
            const callbackName = 'flat_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                if (data && data.data) {
                    // Find the specific flat in the returned data
                    const existingRecord = data.data.find(item => 
                        item.tower === tower && item.flat === flatNumber
                    );
                    
                    if (existingRecord) {
                        populateFormWithData(processType, existingRecord);
                        showNotification(`Loaded data for Flat ${flatNumber} from Google Sheets`, 'info');
                    } else {
                        // If not found in Google Sheets, try local storage
                        loadFromLocalStorage(processKey, tower, flatNumber, processType);
                    }
                }
            };
            
            // Fetch data for this specific process
            script.src = APP_CONFIG.webAppUrl + (APP_CONFIG.webAppUrl.includes('?') ? '&' : '?') + 
                       'action=get_data&process=' + processKey + '&callback=' + callbackName + '&_=' + Date.now();
            document.body.appendChild(script);
            
            // Fallback timeout
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    // If timeout, try local storage
                    loadFromLocalStorage(processKey, tower, flatNumber, processType);
                }
            }, 5000);
        }
        
        function loadFromLocalStorage(processKey, tower, flatNumber, processType) {
            const data = JSON.parse(localStorage.getItem(`hoto_${processKey}`) || '[]');
            const existingRecord = data.find(item => 
                item.tower === tower && item.flat === flatNumber
            );
            
            if (existingRecord) {
                populateFormWithData(processType, existingRecord);
                showNotification(`Loaded local data for Flat ${flatNumber}`, 'info');
            }
        }
        
        function getProcessKey(processType) {
            const keyMap = {
                'key-handover': 'key_handover',
                'snagging': 'snagging',
                'first-visit': 'first_visit',
                'handover': 'handover',
                'interiors': 'interiors',
                'move-in': 'movein',
                'project-mep': 'project_mep',
                'crm': 'crm'
            };
            return keyMap[processType];
        }
        
        function populateFormWithData(processType, data) {
            switch(processType) {
                case 'key-handover':
                    document.getElementById('handoverPerson').value = data.handover_person || '';
                    document.getElementById('receivedByCBRE').value = data.received_by_cbre || '';
                    document.getElementById('handoverDate').value = data.handover_date || '';
                    document.getElementById('allKeysNotHanded').checked = data.all_keys_not_handed === 'Yes';
                    document.getElementById('keyRemarks').value = data.remarks || '';
                    toggleKeyRemarks();
                    break;
                    
                case 'snagging':
                    document.getElementById('mepInspector').value = data.mep_inspector || '';
                    document.getElementById('mepStartDate').value = data.mep_start_date || '';
                    document.getElementById('mepEndDate').value = data.mep_end_date || '';
                    document.getElementById('mepCompleted').checked = data.mep_completed === 'Yes';
                    
                    document.getElementById('civilInspector').value = data.civil_inspector || '';
                    document.getElementById('civilStartDate').value = data.civil_start_date || '';
                    document.getElementById('civilEndDate').value = data.civil_end_date || '';
                    document.getElementById('civilCompleted').checked = data.civil_completed === 'Yes';
                    
                    document.getElementById('electricalInspector').value = data.electrical_inspector || '';
                    document.getElementById('electricalStartDate').value = data.electrical_start_date || '';
                    document.getElementById('electricalEndDate').value = data.electrical_end_date || '';
                    document.getElementById('electricalCompleted').checked = data.electrical_completed === 'Yes';
                    
                    document.getElementById('waterInspector').value = data.water_inspector || '';
                    document.getElementById('waterStartDate').value = data.water_start_date || '';
                    document.getElementById('waterEndDate').value = data.water_end_date || '';
                    document.getElementById('waterCompleted').checked = data.water_completed === 'Yes';
                    
                    document.getElementById('acDrainInspector').value = data.ac_drain_inspector || '';
                    document.getElementById('acDrainStartDate').value = data.ac_drain_start_date || '';
                    document.getElementById('acDrainEndDate').value = data.ac_drain_end_date || '';
                    document.getElementById('acDrainCompleted').checked = data.ac_drain_completed === 'Yes';
                    
                    document.getElementById('tilesInspector').value = data.tiles_inspector || '';
                    document.getElementById('tilesStartDate').value = data.tiles_start_date || '';
                    document.getElementById('tilesEndDate').value = data.tiles_end_date || '';
                    document.getElementById('tilesCompleted').checked = data.tiles_completed === 'Yes';
                    
                    document.getElementById('snagRemarks').value = data.remarks || '';
                    document.getElementById('followupDate').value = data.followup_date || '';
                    checkAllSnaggingCompleted();
                    break;
                    
                case 'project-mep':
                    document.getElementById('snagsStatus').value = data.snags_status || 'attended';
                    document.getElementById('confirmationDate').value = data.confirmation_date || '';
                    document.getElementById('cbreChecked').value = data.cbre_checked || 'no';
                    document.getElementById('cbreCheckedDate').value = data.cbre_checked_date || '';
                    toggleCBRECheckedDate();
                    break;
                    
                case 'crm':
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('informedTo').value = data.informed_to || 'mep';
                    document.getElementById('status').value = data.status || 'open';
                    document.getElementById('followupDateCRM').value = data.followup_date || '';
                    document.getElementById('remarksCRM').value = data.remarks || '';
                    toggleFollowupDate();
                    break;
                    
                case 'first-visit':
                    document.getElementById('ownerName').value = data.owner_name || '';
                    document.getElementById('ownerPhone').value = data.owner_phone || '';
                    document.getElementById('visitDateTime').value = data.visit_date || '';
                    document.getElementById('hotMember').value = data.hot_member || '';
                    document.getElementById('handoverSuggested').value = data.handover_suggested || '';
                    document.getElementById('ownerWillInformDate').checked = data.owner_will_inform === 'Yes';
                    document.getElementById('goingForThirdParty').checked = data.going_for_third_party === 'Yes';
                    
                    if (data.going_for_third_party === 'Yes') {
                        toggleThirdPartyForm();
                        document.getElementById('thirdPartyDateConfirmed').value = data.third_party_date_confirmed || '';
                        document.getElementById('reportReceivedDate').value = data.report_received_date || '';
                        document.getElementById('softCopy').checked = data.soft_copy === 'Yes';
                        document.getElementById('hardCopy').checked = data.hard_copy === 'Yes';
                        document.getElementById('informedToProjectTeam').value = data.informed_to_project_team || 'no';
                        document.getElementById('cbreCheckingDone').value = data.cbre_checking_done || 'no';
                        document.getElementById('customerRemarks').value = data.customer_remarks || '';
                        document.getElementById('crmNoc').value = data.crm_noc || 'pending';
                        
                        if (data.date_not_confirmed === 'Yes') {
                            document.getElementById('dateNotConfirmed').checked = true;
                            toggleThirdPartySubForm();
                        }
                        
                        toggleProjectTeamDate();
                        toggleCBRECheckingDate();
                    }
                    
                    toggleHandoverDate();
                    break;
                    
                case 'handover':
                    document.getElementById('customerName').value = data.customer_name || '';
                    document.getElementById('customerEmail').value = data.customer_email || '';
                    document.getElementById('secondOwnerName').value = data.second_owner_name || '';
                    document.getElementById('secondOwnerEmail').value = data.second_owner_email || '';
                    document.getElementById('hotoMember').value = data.hoto_member || '';
                    document.getElementById('handoverDateTime').value = data.handover_date || '';
                    
                    // Handle items handed checkboxes
                    const itemsHanded = data.items_handed || '';
                    if (itemsHanded.includes('keys')) document.getElementById('itemKeys').checked = true;
                    if (itemsHanded.includes('manual')) document.getElementById('itemManual').checked = true;
                    if (itemsHanded.includes('gift')) document.getElementById('itemGift').checked = true;
                    
                    document.getElementById('customerFeedback').value = data.customer_feedback || '';
                    document.getElementById('finalInspection').value = data.final_inspection || 'yes';
                    document.getElementById('inspectionRemarks').value = data.inspection_remarks || '';
                    toggleInspectionRemarks();
                    break;
                    
                case 'interiors':
                    document.getElementById('siteSupervisor').value = data.site_supervisor || '';
                    document.getElementById('siteSupervisorNumber').value = data.site_supervisor_number || '';
                    document.getElementById('contractorName').value = data.contractor_name || '';
                    document.getElementById('contractorContact').value = data.contractor_contact || '';
                    document.getElementById('workStartDate').value = data.work_start_date || '';
                    document.getElementById('estimatedEndDate').value = data.estimated_end_date || '';
                    document.getElementById('interiorsRemarks').value = data.remarks || '';
                    
                    // Handle interior works checkboxes
                    const interiorWorks = data.interior_works || '';
                    const works = interiorWorks.split(', ');
                    document.getElementById('workFlooring').checked = works.includes('flooring');
                    document.getElementById('workPainting').checked = works.includes('painting');
                    document.getElementById('workElectrical').checked = works.includes('electrical');
                    document.getElementById('workPlumbing').checked = works.includes('plumbing');
                    document.getElementById('workCarpentry').checked = works.includes('carpentry');
                    document.getElementById('workFalseCeiling').checked = works.includes('false_ceiling');
                    document.getElementById('workKitchen').checked = works.includes('kitchen');
                    document.getElementById('workWardrobe').checked = works.includes('wardrobe');
                    
                    document.getElementById('dosDontsExplained').checked = data.dos_donts_explained === 'Yes';
                    document.getElementById('multipleVendors').checked = data.multiple_vendors === 'Yes';
                    
                    if (data.multiple_vendors === 'Yes') {
                        toggleMultipleVendors();
                        // Handle additional vendors if needed
                    }
                    break;
                    
                case 'move-in':
                    document.getElementById('moveinCustomerName').value = data.customer_name || '';
                    document.getElementById('moveinContact').value = data.contact_number || '';
                    document.getElementById('moveinDate').value = data.movein_date || '';
                    document.getElementById('moveinTime').value = data.movein_time || 'morning';
                    document.getElementById('moveClearanceGiven').checked = data.move_clearance_given === 'Yes';
                    document.getElementById('moveinRemarks').value = data.movein_remarks || '';
                    toggleMoveinSave();
                    break;
            }
        }
        
        function updateCRMDateTimeDisplay(tower, flatNumber) {
            const datetimeDisplay = document.getElementById('crmFlatDateTime');
            if (!datetimeDisplay) return;
            
            // Get current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Check for existing data
            const keyHandoverData = JSON.parse(localStorage.getItem('hoto_key_handover') || '[]');
            const existingRecord = keyHandoverData.find(item => 
                item.tower === tower && item.flat === flatNumber
            );
            
            if (existingRecord && existingRecord.timestamp) {
                const recordDate = new Date(existingRecord.timestamp);
                datetimeDisplay.innerHTML = `
                    <i class="fas fa-clock"></i>
                    <span>Last updated: ${recordDate.toLocaleDateString()} ${recordDate.toLocaleTimeString()}</span>
                `;
            } else {
                datetimeDisplay.innerHTML = `
                    <i class="fas fa-clock"></i>
                    <span>Current time: ${dateStr} ${timeStr}</span>
                `;
            }
        }
        
        function getFlatFieldId(processType) {
            const fieldMap = {
                'key-handover': 'keyHandoverFlat',
                'snagging': 'snaggingFlat',
                'first-visit': 'firstVisitFlat',
                'handover': 'handoverFlat',
                'interiors': 'interiorsFlat',
                'move-in': 'moveInFlat',
                'project-mep': 'projectMEPFlat',
                'crm': 'crmFlat'
            };
            return fieldMap[processType] || `${processType.replace('-', '')}Flat`;
        }
        
        function getTowerFieldId(processType) {
            const fieldMap = {
                'key-handover': 'keyHandoverTower',
                'snagging': 'snaggingTower',
                'first-visit': 'firstVisitTower',
                'handover': 'handoverTower',
                'interiors': 'interiorsTower',
                'move-in': 'moveInTower',
                'project-mep': 'projectMEPTower',
                'crm': 'crmTower'
            };
            return fieldMap[processType] || `${processType.replace('-', '')}Tower`;
        }
        
        // ===== DASHBOARD FUNCTIONS =====
        function initializeTowerCharts() {
            generateTowerCharts('all');
        }
        
        function generateTowerCharts(filter) {
            const towers = BUILDING_CONFIG.towers;
            const processes = [
                { id: 'key', name: 'Key Handover', color: '#80BBAD' },
                { id: 'snag', name: 'CBRE Snagging', color: '#17E88F' },
                { id: 'project', name: 'Project/MEP', color: '#6f42c1' },
                { id: 'crm', name: 'CRM', color: '#20c997' },
                { id: 'visit', name: 'First Visit', color: '#DBD99A' },
                { id: 'hoto', name: 'Handover', color: '#3E7CA6' },
                { id: 'interior', name: 'Interiors', color: '#885073' },
                { id: 'movein', name: 'Move-in', color: '#1F3765' }
            ];
            
            const chartContainer = document.getElementById('tower-progress-chart');
            chartContainer.innerHTML = '';
            
            towers.forEach(tower => {
                const chartCard = document.createElement('div');
                chartCard.className = 'tower-chart-card';
                chartCard.style.borderLeftColor = getTowerColor(tower);
                
                const totalCountableFlatsPerTower = BUILDING_CONFIG.countableFlatsPerTower;
                
                const towerData = processes.map(process => {
                    const key = getStorageKey(process.id);
                    const data = JSON.parse(localStorage.getItem(key) || '[]');
                    const towerData = data.filter(item => 
                        item.tower === tower && !isRefugeFlat(item.flat)
                    );
                    const completed = towerData.length;
                    const percent = Math.round((completed / totalCountableFlatsPerTower) * 100);
                    return { ...process, completed, percent };
                });
                
                let chartContent = `
                    <div class="tower-chart-header">
                        <div class="tower-name">Tower ${tower}</div>
                        <div style="font-size: 0.9rem; color: #666;">Countable flats: ${totalCountableFlatsPerTower}</div>
                    </div>
                `;
                
                const filteredProcesses = filter === 'all' 
                    ? towerData 
                    : towerData.filter(p => p.id === filter);
                
                filteredProcesses.forEach(process => {
                    chartContent += `
                        <div class="process-chart-item">
                            <div class="process-name">
                                <span>${process.name}</span>
                                <span class="process-percent">${process.percent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${process.percent}%; background-color: ${process.color};"></div>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                                ${process.completed} of ${totalCountableFlatsPerTower} countable flats
                            </div>
                        </div>
                    `;
                });
                
                chartCard.innerHTML = chartContent;
                chartContainer.appendChild(chartCard);
            });
            
            // Update filter buttons
            document.querySelectorAll('.chart-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (filter === 'all' && btn.textContent === 'All Processes') {
                    btn.classList.add('active');
                } else if (filter !== 'all' && btn.textContent.toLowerCase().includes(filter)) {
                    btn.classList.add('active');
                }
            });
        }
        
        function getStorageKey(processId) {
            const keyMap = {
                'key': 'hoto_key_handover',
                'snag': 'hoto_snagging',
                'visit': 'hoto_first_visit',
                'hoto': 'hoto_handover',
                'interior': 'hoto_interiors',
                'movein': 'hoto_movein',
                'project': 'hoto_project_mep',
                'crm': 'hoto_crm'
            };
            return keyMap[processId] || `hoto_${processId}`;
        }
        
        function filterChartData(filter) {
            generateTowerCharts(filter);
        }
        
        function getTowerColor(tower) {
            switch(tower) {
                case 'A': return '#1F3765';
                case 'B': return '#3E7CA6';
                case 'C': return '#80BBAD';
                default: return '#666';
            }
        }
        
        function updateDashboardCounts() {
            const processes = [
                { key: 'key_handover', elementId: 'totalKeyHandovers', progressId: 'keyHandoverProgress', percentId: 'keyHandoverPercent' },
                { key: 'snagging', elementId: 'totalSnagging', progressId: 'snaggingProgress', percentId: 'snaggingPercent' },
                { key: 'project_mep', elementId: 'totalProjectMEP', progressId: 'projectMEPProgress', percentId: 'projectMEPPercent' },
                { key: 'crm', elementId: 'totalCRM', progressId: 'crmProgress', percentId: 'crmPercent' },
                { key: 'first_visit', elementId: 'totalFirstVisits', progressId: 'firstVisitProgress', percentId: 'firstVisitPercent' },
                { key: 'handover', elementId: 'totalHandovers', progressId: 'handoverProgress', percentId: 'handoverPercent' },
                { key: 'interiors', elementId: 'totalInteriors', progressId: 'interiorProgress', percentId: 'interiorPercent' },
                { key: 'movein', elementId: 'totalMoveins', progressId: 'moveinProgress', percentId: 'moveinPercent' }
            ];
            
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process.key}`) || '[]');
                const nonRefugeData = data.filter(item => !isRefugeFlat(item.flat));
                const count = nonRefugeData.length;
                const totalCountableFlats = BUILDING_CONFIG.countableFlatsOverall;
                const percent = Math.round((count / totalCountableFlats) * 100);
                
                document.getElementById(process.elementId).textContent = count;
                document.getElementById(process.progressId).style.width = `${percent}%`;
                document.getElementById(process.percentId).textContent = `${percent}%`;
            });
        }
        
        // ===== EDIT FUNCTIONALITY =====
        function loadExistingData(processKey) {
            // Get the current tab to determine which process we're in
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return;
            
            const tabText = activeTab.textContent.trim();
            let processType = '';
            
            // Map tab text to process type
            if (tabText.includes('Key Handover')) processType = 'key-handover';
            else if (tabText.includes('CBRE Snagging')) processType = 'snagging';
            else if (tabText.includes('Project/MEP')) processType = 'project-mep';
            else if (tabText.includes('CRM')) processType = 'crm';
            else if (tabText.includes('First Visit')) processType = 'first-visit';
            else if (tabText.includes('Handover')) processType = 'handover';
            else if (tabText.includes('Interiors')) processType = 'interiors';
            else if (tabText.includes('Move-in')) processType = 'move-in';
            
            if (!processType) {
                showNotification('Cannot determine current process', 'error');
                return;
            }
            
            // Get selected flat
            const flatFieldId = getFlatFieldId(processType);
            const towerFieldId = getTowerFieldId(processType);
            
            const flatField = document.getElementById(flatFieldId);
            const towerField = document.getElementById(towerFieldId);
            
            if (!flatField || !flatField.value || !towerField || !towerField.value) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            const flat = flatField.value;
            const tower = towerField.value;
            
            // Load data from localStorage
            const data = JSON.parse(localStorage.getItem(`hoto_${processKey}`) || '[]');
            const existingRecord = data.find(item => 
                item.tower === tower && item.flat === flat
            );
            
            if (!existingRecord) {
                showNotification('No existing data found for this flat', 'warning');
                return;
            }
            
            // Populate form with existing data
            populateFormWithData(processType, existingRecord);
            isEditingMode = true;
            currentEditingProcess = processKey;
            
            showNotification(`Editing existing data for Flat ${flat}`, 'success');
        }
        
        // ===== WORKFLOW FUNCTIONS =====
        function isRefugeFlat(flatNumber) {
            const floor = Math.floor(parseInt(flatNumber) / 100);
            return BUILDING_CONFIG.refugeFlats[floor] && 
                   BUILDING_CONFIG.refugeFlats[floor].includes(parseInt(flatNumber));
        }
        
        // ===== KEY HANDOVER FUNCTIONS =====
        function saveKeyHandover() {
            const flat = document.getElementById('keyHandoverFlat').value;
            const tower = document.getElementById('keyHandoverTower').value;
            const handoverPerson = document.getElementById('handoverPerson').value;
            const receivedByCBRE = document.getElementById('receivedByCBRE').value;
            const handoverDate = document.getElementById('handoverDate').value;
            const allKeysNotHanded = document.getElementById('allKeysNotHanded').checked;
            const remarks = document.getElementById('keyRemarks').value;
            
            if (!handoverPerson || !receivedByCBRE || !handoverDate) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const data = {
                tower: tower,
                flat: flat,
                handover_person: handoverPerson,
                received_by_cbre: receivedByCBRE,
                handover_date: handoverDate,
                all_keys_not_handed: allKeysNotHanded ? 'Yes' : 'No',
                remarks: remarks || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('key_handover', data);
            resetKeyForm();
        }
        
        function toggleKeyRemarks() {
            const allKeysNotHanded = document.getElementById('allKeysNotHanded').checked;
            const remarksContainer = document.getElementById('keyRemarksContainer');
            if (remarksContainer) {
                remarksContainer.style.display = allKeysNotHanded ? 'block' : 'none';
            }
        }
        
        function resetKeyForm() {
            document.getElementById('handoverPerson').value = '';
            document.getElementById('receivedByCBRE').value = '';
            document.getElementById('allKeysNotHanded').checked = false;
            document.getElementById('keyRemarks').value = '';
            toggleKeyRemarks();
            isEditingMode = false;
        }
        
        // ===== CBRE SNAGGING FUNCTIONS =====
        function checkAllSnaggingCompleted() {
            const checkboxes = [
                'mepCompleted', 'civilCompleted', 'electricalCompleted',
                'waterCompleted', 'acDrainCompleted', 'tilesCompleted'
            ];
            
            const allCompleted = checkboxes.every(id => 
                document.getElementById(id)?.checked === true
            );
            
            const saveBtn = document.getElementById('saveSnaggingBtn');
            const moveBtn = document.getElementById('moveToProjectMEPBtn');
            
            if (saveBtn && moveBtn) {
                if (allCompleted) {
                    saveBtn.style.display = 'none';
                    moveBtn.style.display = 'inline-flex';
                } else {
                    saveBtn.style.display = 'inline-flex';
                    moveBtn.style.display = 'none';
                }
            }
            
            const followupContainer = document.getElementById('followupDateContainer');
            if (followupContainer) {
                followupContainer.style.display = allCompleted ? 'none' : 'block';
            }
        }
        
        function saveSnagging() {
            const flat = document.getElementById('snaggingFlat').value;
            const tower = document.getElementById('snaggingTower').value;
            
            const data = {
                tower: tower,
                flat: flat,
                mep_inspector: document.getElementById('mepInspector').value || '',
                mep_start_date: document.getElementById('mepStartDate').value || '',
                mep_end_date: document.getElementById('mepEndDate').value || '',
                mep_completed: document.getElementById('mepCompleted').checked ? 'Yes' : 'No',
                civil_inspector: document.getElementById('civilInspector').value || '',
                civil_start_date: document.getElementById('civilStartDate').value || '',
                civil_end_date: document.getElementById('civilEndDate').value || '',
                civil_completed: document.getElementById('civilCompleted').checked ? 'Yes' : 'No',
                electrical_inspector: document.getElementById('electricalInspector').value || '',
                electrical_start_date: document.getElementById('electricalStartDate').value || '',
                electrical_end_date: document.getElementById('electricalEndDate').value || '',
                electrical_completed: document.getElementById('electricalCompleted').checked ? 'Yes' : 'No',
                water_inspector: document.getElementById('waterInspector').value || '',
                water_start_date: document.getElementById('waterStartDate').value || '',
                water_end_date: document.getElementById('waterEndDate').value || '',
                water_completed: document.getElementById('waterCompleted').checked ? 'Yes' : 'No',
                ac_drain_inspector: document.getElementById('acDrainInspector').value || '',
                ac_drain_start_date: document.getElementById('acDrainStartDate').value || '',
                ac_drain_end_date: document.getElementById('acDrainEndDate').value || '',
                ac_drain_completed: document.getElementById('acDrainCompleted').checked ? 'Yes' : 'No',
                tiles_inspector: document.getElementById('tilesInspector').value || '',
                tiles_start_date: document.getElementById('tilesStartDate').value || '',
                tiles_end_date: document.getElementById('tilesEndDate').value || '',
                tiles_completed: document.getElementById('tilesCompleted').checked ? 'Yes' : 'No',
                remarks: document.getElementById('snagRemarks').value || '',
                followup_date: document.getElementById('followupDate').value || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('snagging', data);
            resetSnagForm();
        }
        
        function moveToProjectMEP() {
            const flat = document.getElementById('snaggingFlat').value;
            const tower = document.getElementById('snaggingTower').value;
            
            if (!flat || !tower) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            // Save snagging data first
            saveSnagging();
            
            // Move to Project/MEP
            const projectMEPData = {
                tower: tower,
                flat: flat,
                snags_status: 'attended',
                confirmation_date: '',
                cbre_checked: 'no',
                cbre_checked_date: '',
                timestamp: new Date().toISOString()
            };
            
            saveData('project_mep', projectMEPData);
            showNotification(`Flat ${flat} moved to Project/MEP`, 'success');
            
            // Navigate to Project/MEP tab
            setTimeout(() => {
                openTab('project-mep');
                // Auto-select the same flat in Project/MEP tab
                setTimeout(() => {
                    const flatItem = document.querySelector(`#project-mep-flat-grid .flat-item[data-flat="${flat}"][data-tower="${tower}"]`);
                    if (flatItem) {
                        flatItem.click();
                    }
                }, 500);
            }, 1000);
        }
        
        function resetSnagForm() {
            // Reset all snagging fields
            const fields = [
                'mepInspector', 'mepStartDate', 'mepEndDate',
                'civilInspector', 'civilStartDate', 'civilEndDate',
                'electricalInspector', 'electricalStartDate', 'electricalEndDate',
                'waterInspector', 'waterStartDate', 'waterEndDate',
                'acDrainInspector', 'acDrainStartDate', 'acDrainEndDate',
                'tilesInspector', 'tilesStartDate', 'tilesEndDate',
                'snagRemarks', 'followupDate'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            const checkboxes = [
                'mepCompleted', 'civilCompleted', 'electricalCompleted',
                'waterCompleted', 'acDrainCompleted', 'tilesCompleted'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            checkAllSnaggingCompleted();
            isEditingMode = false;
        }
        
        // ===== PROJECT/MEP FUNCTIONS =====
        function toggleCBRECheckedDate() {
            const cbreChecked = document.getElementById('cbreChecked').value;
            const dateContainer = document.getElementById('cbreCheckedDateContainer');
            
            if (dateContainer) {
                if (cbreChecked === 'yes') {
                    dateContainer.style.display = 'block';
                    document.getElementById('cbreCheckedDate').value = new Date().toISOString().split('T')[0];
                } else {
                    dateContainer.style.display = 'none';
                    document.getElementById('cbreCheckedDate').value = '';
                }
            }
        }
        
        function saveProjectMEP() {
            const flat = document.getElementById('projectMEPFlat').value;
            const tower = document.getElementById('projectMEPTower').value;
            const cbreChecked = document.getElementById('cbreChecked').value;
            
            const data = {
                tower: tower,
                flat: flat,
                snags_status: document.getElementById('snagsStatus').value || 'not_attended',
                confirmation_date: document.getElementById('confirmationDate').value || '',
                cbre_checked: cbreChecked,
                cbre_checked_date: cbreChecked === 'yes' ? document.getElementById('cbreCheckedDate').value || '' : '',
                timestamp: new Date().toISOString()
            };
            
            saveData('project_mep', data);
            resetProjectMEPForm();
        }
        
        function moveToCRM() {
            const flat = document.getElementById('projectMEPFlat').value;
            const tower = document.getElementById('projectMEPTower').value;
            
            if (!flat || !tower) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            // Save project/MEP data first
            saveProjectMEP();
            
            // Navigate to CRM tab
            setTimeout(() => {
                openTab('crm');
                // Auto-select the same flat in CRM tab
                setTimeout(() => {
                    const flatItem = document.querySelector(`#crm-flat-grid .flat-item[data-flat="${flat}"][data-tower="${tower}"]`);
                    if (flatItem) {
                        flatItem.click();
                    }
                }, 500);
            }, 1000);
        }
        
        function resetProjectMEPForm() {
            document.getElementById('snagsStatus').value = 'attended';
            document.getElementById('confirmationDate').value = '';
            document.getElementById('cbreChecked').value = 'no';
            document.getElementById('cbreCheckedDate').value = '';
            toggleCBRECheckedDate();
            isEditingMode = false;
        }
        
        // ===== FIRST VISIT FUNCTIONS =====
        function toggleHandoverDate() {
            const ownerWillInform = document.getElementById('ownerWillInformDate').checked;
            const handoverSuggestedInput = document.getElementById('handoverSuggested');
            
            if (handoverSuggestedInput) {
                handoverSuggestedInput.disabled = ownerWillInform;
                if (ownerWillInform) {
                    handoverSuggestedInput.value = '';
                }
            }
        }
        
        function toggleThirdPartyForm() {
            const goingForThirdParty = document.getElementById('goingForThirdParty').checked;
            const thirdPartyForm = document.getElementById('thirdPartyForm');
            
            if (thirdPartyForm) {
                thirdPartyForm.style.display = goingForThirdParty ? 'block' : 'none';
            }
        }
        
        function toggleThirdPartySubForm() {
            const dateNotConfirmed = document.getElementById('dateNotConfirmed').checked;
            const thirdPartySubForm = document.getElementById('thirdPartySubForm');
            
            if (thirdPartySubForm) {
                thirdPartySubForm.style.display = dateNotConfirmed ? 'none' : 'block';
            }
        }
        
        function toggleProjectTeamDate() {
            const informedToProjectTeam = document.getElementById('informedToProjectTeam').value;
            const projectTeamDateContainer = document.getElementById('projectTeamDateContainer');
            
            if (projectTeamDateContainer) {
                projectTeamDateContainer.style.display = informedToProjectTeam === 'yes' ? 'block' : 'none';
                if (informedToProjectTeam === 'yes') {
                    document.getElementById('projectTeamInformedDate').value = new Date().toISOString().split('T')[0];
                }
            }
        }
        
        function toggleCBRECheckingDate() {
            const cbreCheckingDone = document.getElementById('cbreCheckingDone').value;
            const cbreCheckingDateContainer = document.getElementById('cbreCheckingDateContainer');
            
            if (cbreCheckingDateContainer) {
                cbreCheckingDateContainer.style.display = cbreCheckingDone === 'yes' ? 'block' : 'none';
                if (cbreCheckingDone === 'yes') {
                    document.getElementById('cbreCheckingDate').value = new Date().toISOString().split('T')[0];
                }
            }
        }
        
        function saveFirstVisit() {
            const flat = document.getElementById('firstVisitFlat').value;
            const tower = document.getElementById('firstVisitTower').value;
            const ownerWillInform = document.getElementById('ownerWillInformDate').checked;
            const goingForThirdParty = document.getElementById('goingForThirdParty').checked;
            const dateNotConfirmed = document.getElementById('dateNotConfirmed')?.checked || false;
            
            // If date not confirmed, save only basic info
            if (goingForThirdParty && dateNotConfirmed) {
                const basicData = {
                    tower: tower,
                    flat: flat,
                    owner_name: document.getElementById('ownerName').value || '',
                    owner_phone: document.getElementById('ownerPhone').value || '',
                    visit_date: document.getElementById('visitDateTime').value || '',
                    hot_member: document.getElementById('hotMember').value || '',
                    going_for_third_party: 'Yes',
                    third_party_date_confirmed: 'No',
                    timestamp: new Date().toISOString()
                };
                
                saveData('first_visit', basicData);
                resetVisitForm();
                showNotification('First visit saved (Third party date not confirmed)', 'success');
                return;
            }
            
            // Full save
            const data = {
                tower: tower,
                flat: flat,
                owner_name: document.getElementById('ownerName').value || '',
                owner_phone: document.getElementById('ownerPhone').value || '',
                visit_date: document.getElementById('visitDateTime').value || '',
                hot_member: document.getElementById('hotMember').value || '',
                handover_suggested: ownerWillInform ? '' : document.getElementById('handoverSuggested').value || '',
                owner_will_inform: ownerWillInform ? 'Yes' : 'No',
                going_for_third_party: goingForThirdParty ? 'Yes' : 'No',
                third_party_date_confirmed: goingForThirdParty ? document.getElementById('thirdPartyDateConfirmed').value || '' : '',
                report_received_date: goingForThirdParty ? document.getElementById('reportReceivedDate').value || '' : '',
                soft_copy: goingForThirdParty ? (document.getElementById('softCopy').checked ? 'Yes' : 'No') : '',
                hard_copy: goingForThirdParty ? (document.getElementById('hardCopy').checked ? 'Yes' : 'No') : '',
                informed_to_project_team: goingForThirdParty ? document.getElementById('informedToProjectTeam').value || '' : '',
                project_team_informed_date: goingForThirdParty ? document.getElementById('projectTeamInformedDate').value || '' : '',
                cbre_checking_done: goingForThirdParty ? document.getElementById('cbreCheckingDone').value || '' : '',
                cbre_checking_date: goingForThirdParty ? document.getElementById('cbreCheckingDate').value || '' : '',
                customer_remarks: document.getElementById('customerRemarks').value || '',
                crm_noc: document.getElementById('crmNoc').value || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('first_visit', data);
            resetVisitForm();
            
            // If report received, move to Project/MEP
            if (goingForThirdParty && data.report_received_date) {
                showNotification('First visit saved. Report received - moving to Project/MEP', 'success');
                setTimeout(() => {
                    const projectMEPData = {
                        tower: tower,
                        flat: flat,
                        snags_status: 'attended',
                        confirmation_date: data.report_received_date,
                        cbre_checked: 'yes',
                        cbre_checked_date: data.cbre_checking_date || '',
                        timestamp: new Date().toISOString()
                    };
                    
                    saveData('project_mep', projectMEPData);
                    showNotification('Moved to Project/MEP', 'info');
                }, 1000);
            }
        }
        
        function moveToCRMFromThirdParty() {
            const flat = document.getElementById('firstVisitFlat').value;
            const tower = document.getElementById('firstVisitTower').value;
            
            if (!flat || !tower) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            // Save first visit data
            saveFirstVisit();
            
            // Navigate to CRM tab
            setTimeout(() => {
                openTab('crm');
                // Auto-select the same flat in CRM tab
                setTimeout(() => {
                    const flatItem = document.querySelector(`#crm-flat-grid .flat-item[data-flat="${flat}"][data-tower="${tower}"]`);
                    if (flatItem) {
                        flatItem.click();
                    }
                }, 500);
            }, 1000);
        }
        
        function resetVisitForm() {
            // Reset all first visit fields
            const fields = [
                'ownerName', 'ownerPhone', 'visitDateTime', 'hotMember',
                'handoverSuggested', 'thirdPartyDateConfirmed', 'reportReceivedDate',
                'projectTeamInformedDate', 'cbreCheckingDate', 'customerRemarks'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            const checkboxes = [
                'ownerWillInformDate', 'goingForThirdParty', 'dateNotConfirmed',
                'softCopy', 'hardCopy'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            const selects = ['crmNoc', 'informedToProjectTeam', 'cbreCheckingDone'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) select.value = 'no';
            });
            
            // Hide third party form
            const thirdPartyForm = document.getElementById('thirdPartyForm');
            if (thirdPartyForm) thirdPartyForm.style.display = 'none';
            
            const thirdPartySubForm = document.getElementById('thirdPartySubForm');
            if (thirdPartySubForm) thirdPartySubForm.style.display = 'block';
            
            // Reset date containers
            document.getElementById('projectTeamDateContainer').style.display = 'none';
            document.getElementById('cbreCheckingDateContainer').style.display = 'none';
            
            // Enable handover suggested
            const handoverSuggested = document.getElementById('handoverSuggested');
            if (handoverSuggested) handoverSuggested.disabled = false;
            
            isEditingMode = false;
        }
        
        // ===== INTERIORS FUNCTIONS =====
        function toggleMultipleVendors() {
            const multipleVendors = document.getElementById('multipleVendors').checked;
            const mainVendorForm = document.getElementById('mainVendorForm');
            const addVendorBtn = document.getElementById('addVendorBtn');
            const additionalVendorsContainer = document.getElementById('additionalVendorsContainer');
            
            if (mainVendorForm) {
                if (multipleVendors) {
                    // Disable main vendor form and show additional vendors
                    const inputs = mainVendorForm.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.style.backgroundColor = '#f8f9fa';
                    });
                    
                    // Show additional vendors container
                    additionalVendorsContainer.classList.remove('hidden');
                    addVendorBtn.style.display = 'inline-flex';
                } else {
                    // Enable main vendor form and hide additional vendors
                    const inputs = mainVendorForm.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.style.backgroundColor = '';
                    });
                    
                    // Hide additional vendors
                    additionalVendorsContainer.classList.add('hidden');
                    addVendorBtn.style.display = 'none';
                }
            }
        }
        
        function addAdditionalVendor() {
            const additionalVendorsContainer = document.getElementById('additionalVendorsContainer');
            const clone = additionalVendorsContainer.cloneNode(true);
            clone.classList.remove('hidden');
            
            // Clear values in cloned form
            const inputs = clone.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type !== 'checkbox') {
                    input.value = '';
                } else {
                    input.checked = false;
                }
            });
            
            // Add remove functionality
            const removeBtn = clone.querySelector('.remove-vendor');
            if (removeBtn) {
                removeBtn.onclick = function() {
                    clone.remove();
                };
            }
            
            // Insert after the current additional vendors container
            additionalVendorsContainer.parentNode.insertBefore(clone, additionalVendorsContainer.nextSibling);
        }
        
        function removeVendor(button) {
            const vendorForm = button.closest('.vendor-form');
            if (vendorForm) {
                vendorForm.remove();
            }
        }
        
        function saveInteriors() {
            const flat = document.getElementById('interiorsFlat').value;
            const tower = document.getElementById('interiorsTower').value;
            const multipleVendors = document.getElementById('multipleVendors').checked;
            
            // Collect interior works
            const interiorWorks = [];
            const workCheckboxes = [
                'workFlooring', 'workPainting', 'workElectrical', 'workPlumbing',
                'workCarpentry', 'workFalseCeiling', 'workKitchen', 'workWardrobe'
            ];
            
            workCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    interiorWorks.push(checkbox.value);
                }
            });
            
            // Collect additional vendors data if multiple vendors
            let additionalVendorsData = '';
            if (multipleVendors) {
                const vendorForms = document.querySelectorAll('.vendor-form:not(.hidden)');
                const vendors = [];
                
                vendorForms.forEach((form, index) => {
                    const contractorName = form.querySelector('.additional-contractor-name')?.value || '';
                    const contractorContact = form.querySelector('.additional-contractor-contact')?.value || '';
                    const startDate = form.querySelector('.additional-start-date')?.value || '';
                    const endDate = form.querySelector('.additional-end-date')?.value || '';
                    const dosDontsExplained = form.querySelector('.additional-dos-donts-explained')?.checked || false;
                    
                    if (contractorName && contractorContact) {
                        vendors.push({
                            contractor_name: contractorName,
                            contractor_contact: contractorContact,
                            work_start_date: startDate,
                            estimated_end_date: endDate,
                            dos_donts_explained: dosDontsExplained ? 'Yes' : 'No'
                        });
                    }
                });
                
                additionalVendorsData = JSON.stringify(vendors);
            }
            
            const data = {
                tower: tower,
                flat: flat,
                contractor_name: multipleVendors ? '' : document.getElementById('contractorName').value || '',
                contractor_contact: multipleVendors ? '' : document.getElementById('contractorContact').value || '',
                work_start_date: multipleVendors ? '' : document.getElementById('workStartDate').value || '',
                estimated_end_date: multipleVendors ? '' : document.getElementById('estimatedEndDate').value || '',
                site_supervisor_number: document.getElementById('siteSupervisorNumber').value || '',
                site_supervisor: document.getElementById('siteSupervisor').value || '',
                interior_works: interiorWorks.join(', '),
                dos_donts_explained: document.getElementById('dosDontsExplained')?.checked ? 'Yes' : 'No',
                multiple_vendors: multipleVendors ? 'Yes' : 'No',
                additional_vendors: additionalVendorsData,
                remarks: document.getElementById('interiorsRemarks').value || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('interiors', data);
            resetInteriorsForm();
        }
        
        function openDeviationForm(processType) {
            currentFlatForDeviation = {
                flat: document.getElementById('interiorsFlat').value || document.getElementById('moveInFlat').value,
                tower: document.getElementById('interiorsTower').value || document.getElementById('moveInTower').value,
                process: processType
            };
            
            // Set today's date
            document.getElementById('deviationVisitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deviationType').value = 'other';
            document.getElementById('deviationDetails').value = '';
            
            // Show modal
            openModal('deviationModal');
        }
        
        function saveDeviation() {
            const visitDate = document.getElementById('deviationVisitDate').value;
            const deviationType = document.getElementById('deviationType').value;
            const deviationDetails = document.getElementById('deviationDetails').value;
            
            if (!visitDate || !deviationType || !deviationDetails) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (!currentFlatForDeviation || !currentFlatForDeviation.flat) {
                showNotification('No flat selected for deviation', 'error');
                return;
            }
            
            const data = {
                tower: currentFlatForDeviation.tower,
                flat: currentFlatForDeviation.flat,
                process: currentFlatForDeviation.process,
                visit_date: visitDate,
                deviation_type: deviationType,
                deviation_details: deviationDetails,
                status: 'open',
                timestamp: new Date().toISOString()
            };
            
            // Save deviation to localStorage
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            deviations.push(data);
            localStorage.setItem('hoto_deviations', JSON.stringify(deviations));
            
            closeModal('deviationModal');
            showNotification('Deviation recorded successfully', 'success');
            
            // Refresh deviations list if on move-in tab
            if (currentFlatForDeviation.process === 'movein') {
                loadDeviationsForMoveIn(currentFlatForDeviation.tower, currentFlatForDeviation.flat);
            }
        }
        
        function loadDeviationsForMoveIn(tower, flat) {
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            const flatDeviations = deviations.filter(d => 
                d.tower === tower && d.flat === flat && d.process === 'interiors'
            );
            
            const deviationsList = document.getElementById('deviationsList');
            const deviationsSection = document.getElementById('deviationsSection');
            
            if (deviationsList) {
                deviationsList.innerHTML = '';
                
                if (flatDeviations.length === 0) {
                    deviationsList.innerHTML = '<p>No deviations recorded for this flat from interiors work.</p>';
                    if (deviationsSection) {
                        deviationsSection.style.display = 'none';
                    }
                } else {
                    flatDeviations.forEach((deviation, index) => {
                        const deviationItem = document.createElement('div');
                        deviationItem.className = 'deviation-item';
                        deviationItem.innerHTML = `
                            <div class="deviation-header">
                                <strong>${deviation.deviation_type.replace('_', ' ').toUpperCase()}</strong>
                                <div class="deviation-status">
                                    <small>${new Date(deviation.visit_date).toLocaleDateString()}</small>
                                </div>
                            </div>
                            <p style="margin-bottom: 10px;">${deviation.deviation_details}</p>
                            <div class="resolution-dropdown">
                                <label for="resolution_${index}">Resolution:</label>
                                <select id="resolution_${index}" data-deviation-id="${deviation.timestamp}" onchange="updateDeviationResolution(this)">
                                    <option value="open" ${deviation.status === 'open' ? 'selected' : ''}>Not Resolved</option>
                                    <option value="resolved" ${deviation.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                </select>
                                <span class="status-${deviation.status === 'resolved' ? 'resolved' : 'not-resolved'}" style="font-weight: 600;">
                                    ${deviation.status === 'resolved' ? '‚úì Resolved' : '‚úó Open'}
                                </span>
                            </div>
                        `;
                        deviationsList.appendChild(deviationItem);
                    });
                    
                    if (deviationsSection) {
                        deviationsSection.style.display = 'block';
                    }
                }
            }
        }
        
        function updateDeviationResolution(selectElement) {
            const deviationId = selectElement.dataset.deviationId;
            const newStatus = selectElement.value;
            
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            const deviationIndex = deviations.findIndex(d => d.timestamp === deviationId);
            
            if (deviationIndex !== -1) {
                deviations[deviationIndex].status = newStatus;
                localStorage.setItem('hoto_deviations', JSON.stringify(deviations));
                
                // Update status display
                const statusSpan = selectElement.nextElementSibling;
                if (statusSpan) {
                    statusSpan.className = `status-${newStatus === 'resolved' ? 'resolved' : 'not-resolved'}`;
                    statusSpan.textContent = newStatus === 'resolved' ? '‚úì Resolved' : '‚úó Open';
                }
                
                showNotification('Deviation status updated', 'success');
            }
        }
        
        function toggleMoveinSave() {
            const moveClearanceGiven = document.getElementById('moveClearanceGiven').checked;
            const saveBtn = document.getElementById('saveMoveinBtn');
            
            if (saveBtn) {
                saveBtn.disabled = !moveClearanceGiven;
            }
        }
        
        function saveMoveIn() {
            const flat = document.getElementById('moveInFlat').value;
            const tower = document.getElementById('moveInTower').value;
            
            // Check if all deviations are resolved
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            const flatDeviations = deviations.filter(d => 
                d.tower === tower && d.flat === flat && d.process === 'interiors'
            );
            
            const unresolvedDeviations = flatDeviations.filter(d => d.status !== 'resolved');
            const allDeviationsResolved = unresolvedDeviations.length === 0;
            
            const data = {
                tower: tower,
                flat: flat,
                customer_name: document.getElementById('moveinCustomerName').value || '',
                contact_number: document.getElementById('moveinContact').value || '',
                movein_date: document.getElementById('moveinDate').value || '',
                movein_time: document.getElementById('moveinTime').value || '',
                move_clearance_given: document.getElementById('moveClearanceGiven').checked ? 'Yes' : 'No',
                deviations_resolved: allDeviationsResolved ? 'Yes' : 'No',
                movein_remarks: document.getElementById('moveinRemarks').value || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('movein', data);
            resetMoveInForm();
        }
        
        function resetInteriorsForm() {
            // Reset all interiors fields
            const fields = [
                'siteSupervisor', 'siteSupervisorNumber', 'contractorName', 'contractorContact',
                'workStartDate', 'estimatedEndDate', 'interiorsRemarks'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            
            const checkboxes = [
                'workFlooring', 'workPainting', 'workElectrical', 'workPlumbing',
                'workCarpentry', 'workFalseCeiling', 'workKitchen', 'workWardrobe',
                'dosDontsExplained', 'multipleVendors'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            // Reset additional vendors
            const additionalVendors = document.querySelectorAll('.vendor-form');
            additionalVendors.forEach((vendor, index) => {
                if (index > 0) {
                    vendor.remove();
                }
            });
            
            const additionalVendorsContainer = document.getElementById('additionalVendorsContainer');
            if (additionalVendorsContainer) {
                additionalVendorsContainer.classList.add('hidden');
            }
            
            const addVendorBtn = document.getElementById('addVendorBtn');
            if (addVendorBtn) {
                addVendorBtn.style.display = 'none';
            }
            
            // Enable main vendor form
            const mainVendorForm = document.getElementById('mainVendorForm');
            if (mainVendorForm) {
                const inputs = mainVendorForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.disabled = false;
                    input.style.backgroundColor = '';
                });
            }
            
            isEditingMode = false;
        }
        
        function resetMoveInForm() {
            document.getElementById('moveinCustomerName').value = '';
            document.getElementById('moveinContact').value = '';
            document.getElementById('moveinDate').value = '';
            document.getElementById('moveinTime').value = 'morning';
            document.getElementById('moveClearanceGiven').checked = false;
            document.getElementById('moveinRemarks').value = '';
            
            toggleMoveinSave();
            
            // Hide deviations section
            const deviationsSection = document.getElementById('deviationsSection');
            if (deviationsSection) {
                deviationsSection.style.display = 'none';
            }
            
            isEditingMode = false;
        }
        
        // ===== GENERAL FUNCTIONS =====
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const datetimeLocal = now.toISOString().slice(0, 16);
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value && !input.hasAttribute('readonly')) {
                    input.value = today;
                }
            });
            
            document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
                if (!input.value) {
                    input.value = datetimeLocal;
                }
            });
            
            // Set default dates for analytics
            document.getElementById('endDate').value = today;
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }
        
        function initializeFormEvents() {
            setDefaultDates();
            
            // Initialize event listeners for dynamic elements
            document.addEventListener('change', function(e) {
                if (e.target.id === 'finalInspection') {
                    toggleInspectionRemarks();
                }
                if (e.target.id === 'status') {
                    toggleFollowupDate();
                }
                if (e.target.id === 'ownerWillInformDate') {
                    toggleHandoverDate();
                }
                if (e.target.id === 'goingForThirdParty') {
                    toggleThirdPartyForm();
                }
                if (e.target.id === 'dateNotConfirmed') {
                    toggleThirdPartySubForm();
                }
                if (e.target.id === 'informedToProjectTeam') {
                    toggleProjectTeamDate();
                }
                if (e.target.id === 'cbreCheckingDone') {
                    toggleCBRECheckingDate();
                }
                if (e.target.id === 'multipleVendors') {
                    toggleMultipleVendors();
                }
                if (e.target.id === 'moveClearanceGiven') {
                    toggleMoveinSave();
                }
                if (e.target.id === 'cbreChecked') {
                    toggleCBRECheckedDate();
                }
                
                // Snagging checkboxes
                const snaggingCheckboxes = [
                    'mepCompleted', 'civilCompleted', 'electricalCompleted',
                    'waterCompleted', 'acDrainCompleted', 'tilesCompleted'
                ];
                
                if (snaggingCheckboxes.includes(e.target.id)) {
                    checkAllSnaggingCompleted();
                }
            });
        }
        
        function refreshData() {
            showNotification('Refreshing data...', 'info');
            
            const refreshBtn = document.querySelector('.control-btn[onclick="refreshData()"]');
            const originalHtml = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
            
            updateDashboardCounts();
            generateTowerCharts('all');
            updateLocalRecordCounts();
            
            // Also refresh from Google Sheets if connected
            if (APP_CONFIG.isConnected) {
                loadFromGoogleSheets();
            }
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalHtml;
                showNotification('Data refreshed successfully!', 'success');
            }, 1000);
        }
        
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            const clickedTab = event?.currentTarget;
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // If opening analytics tab, refresh analytics
            if (tabName === 'analytics') {
                setTimeout(() => {
                    initializeAnalytics();
                }, 100);
            }
        }
        
        function showNotification(message, type = 'info') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${getIconForType(type)}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        function getIconForType(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ===== CRM FUNCTIONS =====
        function viewFlatDetails() {
            const flat = document.getElementById('crmFlat').value;
            const tower = document.getElementById('crmTower').value;
            
            if (!flat || !tower) {
                showNotification('Please select a flat first', 'error');
                return;
            }
            
            // Collect all data for this flat
            const allData = {};
            const processes = [
                { key: 'key_handover', name: 'Key Handover' },
                { key: 'snagging', name: 'CBRE Snagging' },
                { key: 'project_mep', name: 'Project/MEP' },
                { key: 'crm', name: 'CRM' },
                { key: 'first_visit', name: 'First Visit' },
                { key: 'handover', name: 'Handover' },
                { key: 'interiors', name: 'Interiors' },
                { key: 'movein', name: 'Move-in' }
            ];
            
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process.key}`) || '[]');
                const flatData = data.find(item => 
                    item.tower === tower && item.flat === flat
                );
                
                if (flatData) {
                    allData[process.name] = flatData;
                }
            });
            
            // Get deviations
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            const flatDeviations = deviations.filter(d => 
                d.tower === tower && d.flat === flat
            );
            
            if (flatDeviations.length > 0) {
                allData['Deviations'] = flatDeviations;
            }
            
            // Display in modal
            const modalContent = document.getElementById('modalContent');
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #1F3765; margin-bottom: 10px;">
                        <i class="fas fa-building"></i>
                        Flat ${flat} - Tower ${tower}
                    </h3>
                    <p style="color: #666;">Complete History</p>
                </div>
            `;
            
            if (Object.keys(allData).length === 0) {
                html += `
                    <div class="data-section">
                        <h4><i class="fas fa-info-circle"></i> No Data Found</h4>
                        <p>No records found for this flat. Please enter data in the respective tabs.</p>
                    </div>
                `;
            } else {
                for (const [processName, data] of Object.entries(allData)) {
                    if (Array.isArray(data)) {
                        // Deviations array
                        if (data.length > 0) {
                            html += `
                                <div class="data-section">
                                    <h4><i class="fas fa-exclamation-triangle"></i> ${processName}</h4>
                            `;
                            
                            data.forEach((deviation, index) => {
                                html += `
                                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 6px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <strong>${deviation.deviation_type.replace('_', ' ').toUpperCase()}</strong>
                                            <span class="status-${deviation.status === 'resolved' ? 'resolved' : 'not-resolved'}">
                                                ${deviation.status === 'resolved' ? '‚úì Resolved' : '‚úó Open'}
                                            </span>
                                        </div>
                                        <p style="margin-bottom: 5px;">${deviation.deviation_details}</p>
                                        <div style="font-size: 0.9rem; color: #666;">
                                            <i class="fas fa-calendar"></i> ${new Date(deviation.visit_date).toLocaleDateString()}
                                            <span style="margin-left: 15px;"><i class="fas fa-clock"></i> ${new Date(deviation.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `</div>`;
                        }
                    } else {
                        // Single data object
                        html += `
                            <div class="data-section">
                                <h4><i class="fas fa-clipboard-check"></i> ${processName}</h4>
                                <div class="data-row">
                        `;
                        
                        for (const [key, value] of Object.entries(data)) {
                            if (key !== 'tower' && key !== 'flat' && key !== 'timestamp') {
                                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                const formattedValue = value || 'Not specified';
                                
                                html += `
                                    <div class="data-field">
                                        <div class="field-label">${formattedKey}</div>
                                        <div class="field-value">${formattedValue}</div>
                                    </div>
                                `;
                            }
                        }
                        
                        // Add timestamp
                        if (data.timestamp) {
                            html += `
                                <div class="data-field">
                                    <div class="field-label">Last Updated</div>
                                    <div class="field-value">
                                        <i class="fas fa-clock"></i>
                                        ${new Date(data.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            modalContent.innerHTML = html;
            openModal('detailsModal');
        }
        
        function saveCRM() {
            const flat = document.getElementById('crmFlat').value;
            const tower = document.getElementById('crmTower').value;
            
            const data = {
                tower: tower,
                flat: flat,
                description: document.getElementById('description').value || '',
                informed_to: document.getElementById('informedTo').value || '',
                status: document.getElementById('status').value || 'open',
                followup_date: document.getElementById('followupDateCRM').value || '',
                remarks: document.getElementById('remarksCRM').value || '',
                timestamp: new Date().toISOString()
            };
            
            saveData('crm', data);
            resetCRMForm();
        }
        
        function resetCRMForm() {
            document.getElementById('description').value = '';
            document.getElementById('informedTo').value = 'mep';
            document.getElementById('status').value = 'open';
            document.getElementById('followupDateCRM').value = '';
            document.getElementById('remarksCRM').value = '';
            toggleFollowupDate();
            isEditingMode = false;
        }
        
        function toggleFollowupDate() {
            const status = document.getElementById('status').value;
            const followupContainer = document.getElementById('followupDateCRMContainer');
            
            if (followupContainer) {
                followupContainer.style.display = status === 'open' ? 'block' : 'none';
            }
        }
        
        function toggleInspectionRemarks() {
            const finalInspection = document.getElementById('finalInspection').value;
            const inspectionRemarksContainer = document.getElementById('inspectionRemarksContainer');
            
            if (inspectionRemarksContainer) {
                inspectionRemarksContainer.style.display = finalInspection !== 'yes' ? 'block' : 'none';
            }
        }
        
        // ===== DATA SAVING FUNCTIONS =====
        function saveData(sheetName, data) {
            try {
                const key = `hoto_${sheetName}`;
                const existingData = JSON.parse(localStorage.getItem(key) || '[]');
                
                // Check if record already exists for this tower and flat
                const existingIndex = existingData.findIndex(item => 
                    item.tower === data.tower && item.flat === data.flat);
                
                if (existingIndex >= 0) {
                    existingData[existingIndex] = data;
                } else {
                    existingData.push(data);
                }
                
                localStorage.setItem(key, JSON.stringify(existingData));
                
                // Auto-sync to Google Sheets if enabled
                if (APP_CONFIG.isConnected && APP_CONFIG.webAppUrl && APP_CONFIG.syncMode === 'auto') {
                    // Save to Google Sheets via the web app
                    const xhr = new XMLHttpRequest();
                    const url = APP_CONFIG.webAppUrl + (APP_CONFIG.webAppUrl.includes('?') ? '&' : '?') + 
                               'action=save_data&process=' + sheetName;
                    
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200 || xhr.status === 0) {
                                console.log('Auto-sync to Google Sheets completed');
                                APP_CONFIG.lastSync = new Date().toISOString();
                                updateConnectionStatus();
                            }
                        }
                    };
                    
                    xhr.send(JSON.stringify({data: data}));
                }
                
                showNotification(`${sheetName.replace('_', ' ')} saved successfully!`, 'success');
                updateDashboardCounts();
                generateTowerCharts('all');
                updateLocalRecordCounts();
                
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error saving data: ' + error.message, 'error');
            }
        }
        
        // ===== GOOGLE SHEETS INTEGRATION FUNCTIONS =====
        function testConnection() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            if (!webAppUrl) {
                showNotification('Please enter Web App URL', 'error');
                return;
            }
            
            showNotification('Testing connection...', 'info');
            
            // Use JSONP approach for testing
            const callbackName = 'test_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                if (data.status === 'online') {
                    showNotification('Connection successful! Web App is reachable.', 'success');
                    document.getElementById('connectionStatus').innerHTML = 
                        '<i class="fas fa-check-circle"></i> Connected';
                    document.getElementById('connectionStatus').className = 'status-badge status-connected';
                    APP_CONFIG.isConnected = true;
                    updateConnectionIndicator();
                    
                    // Get statistics
                    getCloudStatistics();
                } else {
                    showNotification('Connection failed. Please check deployment.', 'error');
                }
            };
            
            script.src = webAppUrl + (webAppUrl.includes('?') ? '&' : '?') + 
                       'action=ping&callback=' + callbackName + '&_=' + Date.now();
            document.body.appendChild(script);
            
            // Fallback timeout
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showNotification('Connection test timed out. Please check deployment.', 'warning');
                }
            }, 5000);
        }
        
        function saveConnection() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            const syncMode = document.getElementById('syncMode').value;
            const syncFrequency = document.getElementById('syncFrequency').value;
            
            if (!webAppUrl) {
                showNotification('Please enter Web App URL', 'error');
                return;
            }
            
            APP_CONFIG.webAppUrl = webAppUrl;
            APP_CONFIG.syncMode = syncMode;
            APP_CONFIG.syncFrequency = syncFrequency;
            APP_CONFIG.isConnected = true;
            APP_CONFIG.lastSync = new Date().toISOString();
            
            saveConfig();
            updateConnectionStatus();
            startSyncInterval();
            showNotification('Connection settings saved successfully!', 'success');
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const dataSourceText = document.getElementById('dataSourceText');
            const lastSyncElement = document.getElementById('lastSyncTime');
            const connectionIndicator = document.getElementById('connectionIndicator');
            
            if (APP_CONFIG.isConnected && APP_CONFIG.webAppUrl) {
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                statusElement.className = 'status-badge status-connected';
                dataSourceText.textContent = 'Connected to Google Sheets (Auto-sync: ' + APP_CONFIG.syncMode + ')';
                connectionIndicator.style.color = '#28a745';
                
                if (APP_CONFIG.lastSync) {
                    const lastSync = new Date(APP_CONFIG.lastSync);
                    lastSyncElement.textContent = lastSync.toLocaleString();
                }
            } else {
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Not Connected';
                statusElement.className = 'status-badge status-disconnected';
                dataSourceText.textContent = 'Data stored locally. Connect to Google Sheets for cloud storage.';
                lastSyncElement.textContent = 'Never';
                connectionIndicator.style.color = '#ff6b6b';
            }
            
            const exportBtn = document.getElementById('exportGoogleSheetsBtn');
            if (exportBtn) {
                exportBtn.style.display = APP_CONFIG.isConnected ? 'inline-flex' : 'none';
            }
        }
        
        function updateConnectionIndicator() {
            const indicator = document.getElementById('connectionIndicator');
            if (APP_CONFIG.isConnected) {
                indicator.style.color = '#28a745';
                indicator.title = 'Connected to Google Sheets';
            } else {
                indicator.style.color = '#ff6b6b';
                indicator.title = 'Not connected';
            }
        }
        
        function syncToGoogleSheets() {
            if (!APP_CONFIG.isConnected || !APP_CONFIG.webAppUrl) {
                showNotification('Please connect to Google Sheets first', 'error');
                return;
            }
            
            if (APP_CONFIG.syncInProgress) {
                showNotification('Sync already in progress', 'warning');
                return;
            }
            
            showNotification('Starting sync to Google Sheets...', 'info');
            APP_CONFIG.syncInProgress = true;
            
            const syncButton = document.getElementById('syncButton');
            const loadButton = document.getElementById('loadButton');
            syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            syncButton.disabled = true;
            loadButton.disabled = true;
            
            // Collect all local data
            const allData = {};
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            
            let totalRecords = 0;
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                allData[process] = data;
                totalRecords += data.length;
            });
            
            // Add deviations
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            allData['deviations'] = deviations;
            totalRecords += deviations.length;
            
            updateSyncProgress(0, totalRecords);
            
            // Use JSONP for syncing
            const callbackName = 'sync_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                APP_CONFIG.lastSync = new Date().toISOString();
                APP_CONFIG.syncInProgress = false;
                saveConfig();
                
                updateSyncProgress(totalRecords, totalRecords);
                
                syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync to Google Sheets';
                syncButton.disabled = false;
                loadButton.disabled = false;
                
                showNotification(`Successfully synced ${totalRecords} records to Google Sheets!`, 'success');
                updateConnectionStatus();
                
                // Show sync details
                showSyncDetails({total: totalRecords});
                getCloudStatistics();
            };
            
            script.src = APP_CONFIG.webAppUrl + (APP_CONFIG.webAppUrl.includes('?') ? '&' : '?') + 
                       'action=sync_all&callback=' + callbackName + '&_=' + Date.now() +
                       '&data=' + encodeURIComponent(JSON.stringify(allData));
            document.body.appendChild(script);
            
            // Fallback timeout
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    APP_CONFIG.syncInProgress = false;
                    syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync to Google Sheets';
                    syncButton.disabled = false;
                    loadButton.disabled = false;
                    
                    showNotification('Sync may have completed (check Google Sheet)', 'info');
                }
            }, 15000);
        }
        
        function updateSyncProgress(completed, total) {
            const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('syncProgressPercent').textContent = percent + '%';
            document.getElementById('syncProgressBar').style.width = percent + '%';
        }
        
        function showSyncDetails(syncData) {
            let detailsHtml = '<div style="margin-top: 10px;">';
            
            // Show total records
            detailsHtml += `
                <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 10px; background: #e9f7fe; border-radius: 4px; font-weight: bold;">
                    <span>TOTAL RECORDS SYNCED:</span>
                    <span>${syncData.total || 0}</span>
                </div>
            `;
            
            // Show individual process counts
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                const count = data.length;
                
                detailsHtml += `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        <span>${process.replace('_', ' ').toUpperCase()}:</span>
                        <span style="font-weight: bold;">${count} records</span>
                    </div>
                `;
            });
            
            detailsHtml += '</div>';
            
            document.getElementById('syncDetailsContent').innerHTML = detailsHtml;
            document.getElementById('syncDetails').style.display = 'block';
        }
        
        function loadFromGoogleSheets() {
            if (!APP_CONFIG.isConnected || !APP_CONFIG.webAppUrl) {
                showNotification('Please connect to Google Sheets first', 'error');
                return;
            }
            
            showNotification('Loading data from Google Sheets...', 'info');
            
            const loadButton = document.getElementById('loadButton');
            loadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            loadButton.disabled = true;
            
            // Use JSONP for loading data
            const callbackName = 'load_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
                
                processes.forEach(process => {
                    if (data[process]) {
                        localStorage.setItem(`hoto_${process}`, JSON.stringify(data[process]));
                    }
                });
                
                updateDashboardCounts();
                generateTowerCharts('all');
                updateLocalRecordCounts();
                
                loadButton.innerHTML = '<i class="fas fa-download"></i> Load from Google Sheets';
                loadButton.disabled = false;
                
                showNotification('Data loaded successfully from Google Sheets!', 'success');
            };
            
            script.src = APP_CONFIG.webAppUrl + (APP_CONFIG.webAppUrl.includes('?') ? '&' : '?') + 
                       'action=get_all_data&callback=' + callbackName + '&_=' + Date.now();
            document.body.appendChild(script);
            
            // Fallback timeout
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    loadButton.innerHTML = '<i class="fas fa-download"></i> Load from Google Sheets';
                    loadButton.disabled = false;
                    showNotification('Load timed out. Please check connection.', 'error');
                }
            }, 10000);
        }
        
        function getCloudStatistics() {
            if (!APP_CONFIG.isConnected || !APP_CONFIG.webAppUrl) return;
            
            // Use JSONP for getting stats
            const callbackName = 'stats_callback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(script);
                
                if (data.total !== undefined) {
                    document.getElementById('cloudRecordsCount').textContent = data.total + ' records';
                }
            };
            
            script.src = APP_CONFIG.webAppUrl + (APP_CONFIG.webAppUrl.includes('?') ? '&' : '?') + 
                       'action=get_stats&callback=' + callbackName + '&_=' + Date.now();
            document.body.appendChild(script);
        }
        
        function updateLocalRecordCounts() {
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            let total = 0;
            
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                total += data.length;
            });
            
            document.getElementById('localRecordsCount').textContent = total + ' records';
        }
        
        function disconnectGoogleSheets() {
            if (confirm('Are you sure you want to disconnect from Google Sheets?\n\nAll local data will be preserved, but auto-sync will stop.')) {
                APP_CONFIG.webAppUrl = null;
                APP_CONFIG.isConnected = false;
                APP_CONFIG.lastSync = null;
                
                if (APP_CONFIG.syncInterval) {
                    clearInterval(APP_CONFIG.syncInterval);
                    APP_CONFIG.syncInterval = null;
                }
                
                saveConfig();
                updateConnectionStatus();
                showNotification('Disconnected from Google Sheets', 'info');
            }
        }
        
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(textarea.value)
                .then(() => {
                    showNotification('Code copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showNotification('Failed to copy to clipboard', 'error');
                });
        }
        
        function createGoogleSheetTemplate() {
            const templateUrl = 'https://docs.google.com/spreadsheets/create';
            window.open(templateUrl, '_blank');
            showNotification('Open the new Google Sheet and create the required sheets.', 'info');
        }
        
        function downloadSheetTemplate() {
            let template = '=== HOTO PROCESS TRACKER TEMPLATE ===\n\n';
            
            for (const [process, data] of Object.entries(TEMPLATES)) {
                template += `=== ${data.name.toUpperCase()} ===\n`;
                template += data.columns.join(',') + '\n';
                data.sampleData.forEach(row => {
                    template += row.join(',') + '\n';
                });
                template += '\n\n';
            }
            
            const blob = new Blob([template], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'HOTO_Template.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Template downloaded! Import into Google Sheets.', 'success');
        }
        
        function exportToGoogleSheets() {
            syncToGoogleSheets();
        }
        
        function startSyncInterval() {
            if (APP_CONFIG.syncInterval) {
                clearInterval(APP_CONFIG.syncInterval);
            }
            
            if (APP_CONFIG.isConnected && APP_CONFIG.syncMode === 'auto') {
                let interval = 0;
                
                switch(APP_CONFIG.syncFrequency) {
                    case '5min': interval = 5 * 60 * 1000; break;
                    case '15min': interval = 15 * 60 * 1000; break;
                    case 'hourly': interval = 60 * 60 * 1000; break;
                    default: return;
                }
                
                if (interval > 0) {
                    APP_CONFIG.syncInterval = setInterval(() => {
                        if (!APP_CONFIG.syncInProgress) {
                            syncToGoogleSheets();
                        }
                    }, interval);
                }
            }
        }
        
        // ===== EXCEL PROCESSOR FUNCTIONS =====
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedFileName').textContent = `Selected: ${file.name}`;
            document.getElementById('validationErrors').style.display = 'none';
            document.getElementById('errorList').innerHTML = '';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    excelWorkbook = XLSX.read(data, { type: 'array' });
                    
                    // Validate the file
                    const validationResult = validateExcelFile(excelWorkbook);
                    
                    if (validationResult.isValid) {
                        previewImport();
                        showNotification('File loaded and validated successfully!', 'success');
                    } else {
                        showValidationErrors(validationResult.errors);
                        showNotification('File loaded but has validation errors', 'warning');
                    }
                } catch (error) {
                    showNotification('Error reading file: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Error reading file', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function validateExcelFile(workbook) {
            const errors = [];
            
            if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                errors.push('Workbook has no sheets');
                return { isValid: false, errors };
            }
            
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (jsonData.length < 2) {
                errors.push('Excel file has no data rows (only headers)');
            }
            
            // Check for required columns based on selected template
            const templateType = document.getElementById('templateSelect').value;
            if (templateType) {
                const template = TEMPLATES[templateType];
                if (template && jsonData.length > 0) {
                    const headers = jsonData[0];
                    const requiredColumns = template.columns;
                    
                    requiredColumns.forEach(column => {
                        if (!headers.includes(column)) {
                            errors.push(`Missing required column: "${column}"`);
                        }
                    });
                    
                    // Validate data rows
                    for (let i = 1; i < Math.min(jsonData.length, 11); i++) {
                        const row = jsonData[i];
                        requiredColumns.forEach((column, colIndex) => {
                            if (colIndex < row.length) {
                                const value = row[colIndex];
                                if (column === 'tower' && value && !['A', 'B', 'C'].includes(value.toString().toUpperCase())) {
                                    errors.push(`Row ${i+1}: Invalid tower value "${value}". Must be A, B, or C.`);
                                }
                                if (column === 'flat' && value) {
                                    const flatNum = parseInt(value);
                                    if (isNaN(flatNum) || flatNum < 101 || flatNum > 935) {
                                        errors.push(`Row ${i+1}: Invalid flat number "${value}". Must be between 101 and 935.`);
                                    }
                                }
                                if ((column.includes('date') || column === 'timestamp') && value) {
                                    if (!isValidDate(value)) {
                                        errors.push(`Row ${i+1}: Invalid date format in column "${column}"`);
                                    }
                                }
                            }
                        });
                    }
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        function isValidDate(dateString) {
            // Try to parse the date
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }
        
        function showValidationErrors(errors) {
            const errorContainer = document.getElementById('validationErrors');
            const errorList = document.getElementById('errorList');
            
            if (errors.length > 0) {
                let errorHtml = '';
                errors.forEach((error, index) => {
                    errorHtml += `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            ${error}
                        </div>
                    `;
                });
                
                errorList.innerHTML = errorHtml;
                errorContainer.style.display = 'block';
                
                // Disable process import button
                const processBtn = document.getElementById('processImportBtn');
                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.title = 'Please fix validation errors first';
                }
            }
        }
        
        function handleFileDrop(event) {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            if (file) {
                document.getElementById('excelFileInput').files = event.dataTransfer.files;
                handleFileSelect(event);
            }
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        }
        
        function previewImport() {
            if (!excelWorkbook) {
                showNotification('Please upload an Excel file first', 'error');
                return;
            }
            
            const sheetName = excelWorkbook.SheetNames[0];
            const worksheet = excelWorkbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const previewTable = document.getElementById('previewTable');
            let html = '<table class="excel-preview-table" style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            
            const rowsToShow = Math.min(10, jsonData.length);
            
            if (jsonData.length > 0) {
                const headers = jsonData[0];
                headers.forEach(header => {
                    html += `<th style="padding: 8px; border: 1px solid #e0e0e0; text-align: left;">${header || 'Column'}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                for (let i = 1; i < rowsToShow; i++) {
                    html += '<tr>';
                    const row = jsonData[i] || [];
                    
                    headers.forEach((header, j) => {
                        const cellValue = j < row.length ? row[j] : '';
                        html += `<td style="padding: 8px; border: 1px solid #e0e0e0;">${cellValue}</td>`;
                    });
                    html += '</tr>';
                }
            }
            
            html += '</tbody></table>';
            
            previewTable.innerHTML = html;
            document.getElementById('filePreview').style.display = 'block';
            
            const totalRows = jsonData.length - 1;
            const totalCols = jsonData[0] ? jsonData[0].length : 0;
            
            document.getElementById('importSummary').style.display = 'block';
            document.getElementById('summaryText').innerHTML = `
                File contains: <strong>${totalRows} rows</strong> and <strong>${totalCols} columns</strong><br>
                First sheet: <strong>${sheetName}</strong><br>
                Ready for import!
            `;
            
            // Enable process import button
            const processBtn = document.getElementById('processImportBtn');
            if (processBtn) {
                processBtn.disabled = false;
                processBtn.title = '';
            }
        }
        
        function processImport() {
            if (!excelWorkbook) {
                showNotification('Please upload an Excel file first', 'error');
                return;
            }
            
            const importProcess = document.getElementById('importProcess').value;
            const importAction = document.getElementById('importAction').value;
            
            if (!importProcess) {
                showNotification('Please select a process to import into', 'error');
                return;
            }
            
            try {
                const sheetName = excelWorkbook.SheetNames[0];
                const worksheet = excelWorkbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    showNotification('Excel file has no data rows', 'error');
                    return;
                }
                
                const headers = jsonData[0];
                const rows = jsonData.slice(1);
                
                const importedData = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    // Add timestamp if not present
                    if (!obj.timestamp) {
                        obj.timestamp = new Date().toISOString();
                    }
                    return obj;
                }).filter(row => row.tower && row.flat); // Filter out rows without tower/flat
                
                const storageKey = `hoto_${importProcess}`;
                const existingData = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                let newData = [];
                if (importAction === 'append') {
                    newData = [...existingData, ...importedData];
                } else if (importAction === 'replace') {
                    newData = importedData;
                } else if (importAction === 'update') {
                    newData = [...existingData];
                    importedData.forEach(newItem => {
                        const index = newData.findIndex(item => 
                            item.tower === newItem.tower && item.flat === newItem.flat);
                        if (index >= 0) {
                            newData[index] = { ...newData[index], ...newItem };
                        } else {
                            newData.push(newItem);
                        }
                    });
                }
                
                localStorage.setItem(storageKey, JSON.stringify(newData));
                
                updateDashboardCounts();
                generateTowerCharts('all');
                updateLocalRecordCounts();
                
                showNotification(`Successfully imported ${importedData.length} records into ${importProcess.replace('_', ' ')}`, 'success');
                
                // Reset form
                document.getElementById('excelFileInput').value = '';
                document.getElementById('selectedFileName').textContent = '';
                document.getElementById('filePreview').style.display = 'none';
                document.getElementById('importSummary').style.display = 'none';
                document.getElementById('validationErrors').style.display = 'none';
                excelWorkbook = null;
                
            } catch (error) {
                showNotification('Error processing import: ' + error.message, 'error');
                console.error('Import error:', error);
            }
        }
        
        function selectTemplate() {
            const templateType = document.getElementById('templateSelect').value;
            selectedTemplate = templateType;
            
            if (templateType) {
                const template = TEMPLATES[templateType];
                if (template) {
                    showNotification(`Selected ${template.name}`, 'info');
                }
            }
        }
        
        function downloadSelectedTemplate() {
            const templateType = document.getElementById('templateSelect').value;
            
            if (!templateType) {
                showNotification('Please select a template type first', 'error');
                return;
            }
            
            const template = TEMPLATES[templateType];
            if (!template) {
                showNotification('Template not found', 'error');
                return;
            }
            
            let csvContent = template.columns.join(',') + '\n';
            template.sampleData.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${template.name.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`${template.name} downloaded successfully!`, 'success');
        }
        
        function exportAllToExcel() {
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            let allData = {};
            
            processes.forEach(process => {
                const key = `hoto_${process}`;
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                allData[process] = data;
            });
            
            let csvContent = '';
            
            processes.forEach(process => {
                const processData = allData[process];
                if (processData.length > 0) {
                    csvContent += `=== ${process.toUpperCase().replace('_', ' ')} ===\n`;
                    const headers = Object.keys(processData[0]);
                    csvContent += headers.join(',') + '\n';
                    
                    processData.forEach(row => {
                        const values = headers.map(header => {
                            const value = row[header];
                            return typeof value === 'string' ? `"${value}"` : value;
                        });
                        csvContent += values.join(',') + '\n';
                    });
                    
                    csvContent += '\n\n';
                }
            });
            
            if (csvContent) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `HOTO_All_Data_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('All data exported successfully!', 'success');
            } else {
                showNotification('No data to export', 'warning');
            }
        }
        
        function exportSelectedProcess() {
            const processSelect = document.getElementById('importProcess');
            const process = processSelect.value;
            
            if (!process) {
                showNotification('Please select a process to export', 'error');
                return;
            }
            
            const key = `hoto_${process}`;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (data.length === 0) {
                showNotification(`No data found for ${process.replace('_', ' ')}`, 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value}"` : value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `HOTO_${process}_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`${process.replace('_', ' ')} data exported successfully!`, 'success');
        }
        
        // Template definitions
        const TEMPLATES = {
            key_handover: {
                name: "Key Handover Template",
                columns: ["tower", "flat", "handover_person", "received_by_cbre", "handover_date", "all_keys_not_handed", "remarks", "timestamp"],
                sampleData: [
                    ["A", "1503", "John Doe", "CBRE Person", "2024-01-15", "No", "All keys handed over", "2024-01-15T10:30:00"]
                ]
            },
            snagging: {
                name: "CBRE Snagging Template",
                columns: ["tower", "flat", "mep_inspector", "mep_start_date", "mep_end_date", "mep_completed", "civil_inspector", "civil_start_date", "civil_end_date", "civil_completed", "electrical_inspector", "electrical_start_date", "electrical_end_date", "electrical_completed", "water_inspector", "water_start_date", "water_end_date", "water_completed", "ac_drain_inspector", "ac_drain_start_date", "ac_drain_end_date", "ac_drain_completed", "tiles_inspector", "tiles_start_date", "tiles_end_date", "tiles_completed", "remarks", "followup_date", "timestamp"],
                sampleData: [
                    ["A", "1503", "MEP Inspector", "2024-01-10", "2024-01-12", "Yes", "Civil Inspector", "2024-01-10", "2024-01-12", "Yes", "Electrical Inspector", "2024-01-11", "2024-01-12", "Yes", "Water Inspector", "2024-01-11", "2024-01-12", "Yes", "AC Drain Inspector", "2024-01-12", "2024-01-12", "Yes", "Tiles Inspector", "2024-01-12", "2024-01-12", "Yes", "All areas completed", "", "2024-01-12T16:20:00"]
                ]
            },
            first_visit: {
                name: "First Visit Template",
                columns: ["tower", "flat", "owner_name", "owner_phone", "visit_date", "hot_member", "handover_suggested", "owner_will_inform", "going_for_third_party", "third_party_date_confirmed", "report_received_date", "soft_copy", "hard_copy", "informed_to_project_team", "project_team_informed_date", "cbre_checking_done", "cbre_checking_date", "customer_remarks", "crm_noc", "timestamp"],
                sampleData: [
                    ["A", "1503", "Robert Chen", "9876543210", "2024-01-18T14:00:00", "David Lee", "2024-02-01", "Yes", "No", "", "", "No", "No", "no", "", "no", "", "Happy with quality", "received", "2024-01-18T16:30:00"]
                ]
            },
            handover: {
                name: "Handover Template",
                columns: ["tower", "flat", "customer_name", "customer_email", "second_owner_name", "second_owner_email", "hoto_member", "handover_date", "items_handed", "customer_feedback", "final_inspection", "inspection_remarks", "timestamp"],
                sampleData: [
                    ["A", "1503", "Robert Chen", "robert@email.com", "Sarah Chen", "sarah@email.com", "Emma Wilson", "2024-02-01T15:00:00", "keys, manual, gift_box", "Excellent service", "yes", "", "2024-02-01T17:30:00"]
                ]
            },
            interiors: {
                name: "Interiors Template",
                columns: ["tower", "flat", "contractor_name", "contractor_contact", "work_start_date", "estimated_end_date", "site_supervisor_number", "site_supervisor", "interior_works", "dos_donts_explained", "multiple_vendors", "additional_vendors", "remarks", "timestamp"],
                sampleData: [
                    ["A", "1503", "Dream Homes Interiors", "9876543210", "2024-02-02", "2024-02-20", "9123456789", "Site Manager", "flooring, painting, electrical", "Yes", "No", "", "On schedule", "2024-02-02T10:00:00"]
                ]
            },
            movein: {
                name: "Move-in Template",
                columns: ["tower", "flat", "customer_name", "contact_number", "movein_date", "movein_time", "move_clearance_given", "deviations_resolved", "movein_remarks", "timestamp"],
                sampleData: [
                    ["A", "1503", "Robert Chen", "9876543210", "2024-02-25", "morning", "Yes", "Yes", "Smooth move-in", "2024-02-25T12:30:00"]
                ]
            },
            project_mep: {
                name: "Project/MEP Template",
                columns: ["tower", "flat", "snags_status", "confirmation_date", "cbre_checked", "cbre_checked_date", "timestamp"],
                sampleData: [
                    ["A", "1503", "attended", "2024-01-20", "yes", "2024-01-20", "2024-01-20T14:30:00"]
                ]
            },
            crm: {
                name: "CRM Template",
                columns: ["tower", "flat", "description", "informed_to", "status", "followup_date", "remarks", "timestamp"],
                sampleData: [
                    ["A", "1503", "Customer inquiry about handover", "mep", "open", "2024-01-25", "Follow up required", "2024-01-20T10:15:00"]
                ]
            }
        };
        
        // ===== ANALYTICS FUNCTIONS =====
        function initializeAnalytics() {
            // Set default date range
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            // Apply default filter
            applyQuickFilter('30days');
            
            // Initialize charts
            updateAnalyticsCharts();
        }
        
        function applyDateFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('Start date cannot be after end date', 'error');
                return;
            }
            
            analyticsFilter.startDate = startDate;
            analyticsFilter.endDate = endDate;
            analyticsFilter.filterType = 'custom';
            
            // Update quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            updateFilteredKPICards();
            updateAnalyticsCharts();
            showNotification('Date filter applied successfully', 'success');
        }
        
        function applyQuickFilter(filterType) {
            const endDate = new Date();
            const startDate = new Date();
            
            switch(filterType) {
                case '7days':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case '30days':
                    startDate.setDate(startDate.getDate() - 30);
                    break;
                case '90days':
                    startDate.setDate(startDate.getDate() - 90);
                    break;
                case '365days':
                    startDate.setDate(startDate.getDate() - 365);
                    break;
                case 'all':
                    startDate = null;
                    break;
            }
            
            analyticsFilter.filterType = filterType;
            
            if (startDate) {
                analyticsFilter.startDate = startDate.toISOString().split('T')[0];
                analyticsFilter.endDate = endDate.toISOString().split('T')[0];
                
                document.getElementById('startDate').value = analyticsFilter.startDate;
                document.getElementById('endDate').value = analyticsFilter.endDate;
            } else {
                analyticsFilter.startDate = null;
                analyticsFilter.endDate = null;
            }
            
            // Update quick filter buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(filterType.replace('days', '').replace('all', 'all time'))) {
                    btn.classList.add('active');
                }
            });
            
            updateFilteredKPICards();
            updateAnalyticsCharts();
        }
        
        function getFilteredData() {
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            const filteredData = {};
            
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                
                if (analyticsFilter.startDate && analyticsFilter.endDate) {
                    filteredData[process] = data.filter(item => {
                        const itemDate = new Date(item.timestamp || item.handover_date || item.visit_date || item.movein_date);
                        const startDate = new Date(analyticsFilter.startDate);
                        const endDate = new Date(analyticsFilter.endDate);
                        endDate.setHours(23, 59, 59, 999); // Include entire end date
                        
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                } else {
                    filteredData[process] = data;
                }
            });
            
            return filteredData;
        }
        
        function updateFilteredKPICards() {
            const filteredData = getFilteredData();
            const kpiContainer = document.getElementById('filtered-kpi-cards');
            
            if (!kpiContainer) return;
            
            const processes = [
                { key: 'key_handover', name: 'Key Handovers', icon: 'key', color: '#80BBAD' },
                { key: 'snagging', name: 'CBRE Snagging', icon: 'search', color: '#17E88F' },
                { key: 'project_mep', name: 'Project/MEP', icon: 'tools', color: '#6f42c1' },
                { key: 'crm', name: 'CRM', icon: 'phone-alt', color: '#20c997' },
                { key: 'first_visit', name: 'First Visits', icon: 'calendar-check', color: '#DBD99A' },
                { key: 'handover', name: 'Handovers', icon: 'handshake', color: '#3E7CA6' },
                { key: 'interiors', name: 'Interiors', icon: 'hammer', color: '#885073' },
                { key: 'movein', name: 'Move-ins', icon: 'home', color: '#1F3765' }
            ];
            
            let kpiHTML = '';
            
            processes.forEach(process => {
                const data = filteredData[process.key] || [];
                const nonRefugeData = data.filter(item => !isRefugeFlat(item.flat));
                const count = nonRefugeData.length;
                const totalCountableFlats = BUILDING_CONFIG.countableFlatsOverall;
                const percent = totalCountableFlats > 0 ? Math.round((count / totalCountableFlats) * 100) : 0;
                
                kpiHTML += `
                    <div class="kpi-card" style="border-top-color: ${process.color}">
                        <div class="kpi-header">
                            <div class="kpi-title">${process.name}</div>
                            <i class="fas fa-${process.icon} fa-2x" style="color: ${process.color};"></i>
                        </div>
                        <div class="kpi-value">${count}</div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Completion</span>
                                <span>${percent}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percent}%; background-color: ${process.color};"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            kpiContainer.innerHTML = kpiHTML;
        }
        
        function updateAnalyticsCharts() {
            const filteredData = getFilteredData();
            
            // Monthly Trends Chart
            updateMonthlyTrendsChart(filteredData);
            
            // Tower Performance Chart
            updateTowerPerformanceChart(filteredData);
            
            // Snagging Status Chart
            updateSnaggingStatusChart(filteredData);
            
            // Weekly Performance Chart
            updateWeeklyPerformanceChart(filteredData);
        }
        
        function updateMonthlyTrendsChart(filteredData) {
            const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
            
            // Get last 6 months
            const months = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
            }
            
            // Prepare data for key handovers
            const keyHandoverData = months.map(month => {
                const [monthName, year] = month.split(' ');
                const monthIndex = monthNames.indexOf(monthName);
                const yearNum = parseInt(year);
                
                const data = filteredData.key_handover || [];
                return data.filter(item => {
                    const itemDate = new Date(item.timestamp || item.handover_date);
                    return itemDate.getMonth() === monthIndex && itemDate.getFullYear() === yearNum;
                }).length;
            });
            
            if (window.monthlyTrendsChart) {
                window.monthlyTrendsChart.destroy();
            }
            
            window.monthlyTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Key Handovers',
                        data: keyHandoverData,
                        borderColor: '#80BBAD',
                        backgroundColor: 'rgba(128, 187, 173, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Monthly Key Handover Trends'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Handovers'
                            }
                        }
                    }
                }
            });
        }
        
        function updateTowerPerformanceChart(filteredData) {
            const ctx = document.getElementById('towerPerformanceChart').getContext('2d');
            
            const towers = BUILDING_CONFIG.towers;
            const processes = ['key_handover', 'snagging', 'project_mep', 'crm'];
            
            const datasets = processes.map((process, index) => {
                const colors = ['#80BBAD', '#17E88F', '#6f42c1', '#20c997'];
                const labels = ['Key Handover', 'CBRE Snagging', 'Project/MEP', 'CRM'];
                
                return {
                    label: labels[index],
                    data: towers.map(tower => {
                        const data = filteredData[process] || [];
                        return data.filter(item => 
                            item.tower === tower && !isRefugeFlat(item.flat)
                        ).length;
                    }),
                    backgroundColor: colors[index] + '80',
                    borderColor: colors[index],
                    borderWidth: 2
                };
            });
            
            if (window.towerPerformanceChart) {
                window.towerPerformanceChart.destroy();
            }
            
            window.towerPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: towers.map(t => `Tower ${t}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Tower Performance Comparison'
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                        },
                        y: {
                            beginAtZero: true,
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Number of Units'
                            }
                        }
                    }
                }
            });
        }
        
        function updateSnaggingStatusChart(filteredData) {
            const ctx = document.getElementById('snaggingStatusChart').getContext('2d');
            
            const snaggingData = filteredData.snagging || [];
            
            // Count by status
            const completed = snaggingData.filter(item => {
                const checkboxes = ['mep_completed', 'civil_completed', 'electrical_completed', 
                                  'water_completed', 'ac_drain_completed', 'tiles_completed'];
                return checkboxes.every(field => item[field] === 'Yes');
            }).length;
            
            const inProgress = snaggingData.filter(item => {
                const checkboxes = ['mep_completed', 'civil_completed', 'electrical_completed', 
                                  'water_completed', 'ac_drain_completed', 'tiles_completed'];
                return checkboxes.some(field => item[field] === 'Yes') && 
                       checkboxes.some(field => item[field] !== 'Yes');
            }).length;
            
            const notStarted = snaggingData.filter(item => {
                const checkboxes = ['mep_completed', 'civil_completed', 'electrical_completed', 
                                  'water_completed', 'ac_drain_completed', 'tiles_completed'];
                return checkboxes.every(field => item[field] !== 'Yes');
            }).length;
            
            if (window.snaggingStatusChart) {
                window.snaggingStatusChart.destroy();
            }
            
            window.snaggingStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [completed, inProgress, notStarted],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'CBRE Snagging Status Distribution'
                        }
                    }
                }
            });
        }
        
        function updateWeeklyPerformanceChart(filteredData) {
            const ctx = document.getElementById('weeklyPerformanceChart').getContext('2d');
            
            // Get last 4 weeks
            const weeks = [];
            const weekData = [[], [], [], []];
            
            for (let i = 3; i >= 0; i--) {
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (i * 7) - 6);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                weeks.push(`Week ${4-i}`);
                
                // Count activities for each week
                ['key_handover', 'snagging', 'handover', 'movein'].forEach((process, idx) => {
                    const data = filteredData[process] || [];
                    const count = data.filter(item => {
                        const itemDate = new Date(item.timestamp || item.handover_date || item.visit_date || item.movein_date);
                        return itemDate >= startDate && itemDate <= endDate;
                    }).length;
                    
                    weekData[idx].push(count);
                });
            }
            
            if (window.weeklyPerformanceChart) {
                window.weeklyPerformanceChart.destroy();
            }
            
            window.weeklyPerformanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Key Handovers',
                            data: weekData[0],
                            borderColor: '#80BBAD',
                            backgroundColor: 'rgba(128, 187, 173, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'CBRE Snagging',
                            data: weekData[1],
                            borderColor: '#17E88F',
                            backgroundColor: 'rgba(23, 232, 143, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Handovers',
                            data: weekData[2],
                            borderColor: '#3E7CA6',
                            backgroundColor: 'rgba(62, 124, 166, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Move-ins',
                            data: weekData[3],
                            borderColor: '#1F3765',
                            backgroundColor: 'rgba(31, 55, 101, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Weekly Performance Metrics (Last 4 Weeks)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Activities'
                            }
                        }
                    }
                }
            });
        }
        
        // ===== REPORT DOWNLOAD FUNCTIONS =====
        function downloadPendingKeysReport() {
            const keyHandovers = JSON.parse(localStorage.getItem('hoto_key_handover') || '[]');
            const pendingKeys = keyHandovers.filter(item => 
                item.all_keys_not_handed === 'Yes' || !item.all_keys_not_handed
            );
            
            exportToCSV(pendingKeys, 'pending_keys_report.csv', 'Pending Keys Report');
        }
        
        function downloadSnaggingAnalyticsReport() {
            const snaggingData = JSON.parse(localStorage.getItem('hoto_snagging') || '[]');
            
            const reportData = snaggingData.map(item => {
                const checkboxes = ['mep_completed', 'civil_completed', 'electrical_completed', 
                                  'water_completed', 'ac_drain_completed', 'tiles_completed'];
                const completedCount = checkboxes.filter(field => item[field] === 'Yes').length;
                const status = completedCount === 6 ? 'Completed' : 
                              completedCount > 0 ? 'In Progress' : 'Not Started';
                
                return {
                    Tower: item.tower,
                    Flat: item.flat,
                    'MEP Status': item.mep_completed || 'No',
                    'Civil Status': item.civil_completed || 'No',
                    'Electrical Status': item.electrical_completed || 'No',
                    'Water Status': item.water_completed || 'No',
                    'AC Drain Status': item.ac_drain_completed || 'No',
                    'Tiles Status': item.tiles_completed || 'No',
                    'Overall Status': status,
                    'Follow-up Date': item.followup_date || '',
                    'Remarks': item.remarks || ''
                };
            });
            
            exportToCSV(reportData, 'snagging_analytics_report.csv', 'CBRE Snagging Analytics Report');
        }
        
        function downloadProductivityReport() {
            const processes = ['key_handover', 'snagging', 'first_visit', 'handover', 'interiors', 'movein', 'project_mep', 'crm'];
            const reportData = [];
            
            processes.forEach(process => {
                const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                const nonRefugeData = data.filter(item => !isRefugeFlat(item.flat));
                
                reportData.push({
                    'Process': process.replace('_', ' ').toUpperCase(),
                    'Completed Units': nonRefugeData.length,
                    'Total Units': BUILDING_CONFIG.countableFlatsOverall,
                    'Completion %': Math.round((nonRefugeData.length / BUILDING_CONFIG.countableFlatsOverall) * 100) + '%',
                    'Pending Units': BUILDING_CONFIG.countableFlatsOverall - nonRefugeData.length
                });
            });
            
            exportToCSV(reportData, 'productivity_report.csv', 'Productivity Report');
        }
        
        function downloadTrendAnalysisReport() {
            // Generate trend data for last 12 months
            const months = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
            }
            
            const processes = ['key_handover', 'snagging', 'handover', 'movein'];
            const reportData = [];
            
            months.forEach(month => {
                const [monthName, year] = month.split(' ');
                const monthIndex = monthNames.indexOf(monthName);
                const yearNum = parseInt(year);
                
                const row = { Month: month };
                
                processes.forEach(process => {
                    const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                    const count = data.filter(item => {
                        const itemDate = new Date(item.timestamp || item.handover_date || item.visit_date || item.movein_date);
                        return itemDate.getMonth() === monthIndex && itemDate.getFullYear() === yearNum;
                    }).length;
                    
                    row[process.replace('_', ' ').toUpperCase()] = count;
                });
                
                reportData.push(row);
            });
            
            exportToCSV(reportData, 'trend_analysis_report.csv', 'Trend Analysis Report');
        }
        
        function downloadAlertSummaryReport() {
            const deviations = JSON.parse(localStorage.getItem('hoto_deviations') || '[]');
            const reportData = deviations.map(deviation => ({
                'Tower': deviation.tower,
                'Flat': deviation.flat,
                'Process': deviation.process,
                'Deviation Type': deviation.deviation_type,
                'Visit Date': deviation.visit_date,
                'Status': deviation.status,
                'Details': deviation.deviation_details,
                'Reported Date': new Date(deviation.timestamp).toLocaleDateString()
            }));
            
            exportToCSV(reportData, 'alert_summary_report.csv', 'Alert Summary Report');
        }
        
        function downloadAllReports() {
            showNotification('Preparing all reports... This may take a moment.', 'info');
            
            // In a real implementation, this would create a ZIP file
            // For this demo, we'll just download the main reports
            setTimeout(() => {
                downloadPendingKeysReport();
                setTimeout(() => {
                    downloadSnaggingAnalyticsReport();
                    setTimeout(() => {
                        downloadProductivityReport();
                        setTimeout(() => {
                            downloadTrendAnalysisReport();
                            setTimeout(() => {
                                downloadAlertSummaryReport();
                                showNotification('All reports downloaded successfully!', 'success');
                            }, 500);
                        }, 500);
                    }, 500);
                }, 500);
            }, 1000);
        }
        
        function downloadMonthlyTrendsReport() {
            // This function would generate a detailed monthly trends report
            const processes = ['key_handover', 'snagging', 'handover', 'movein'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Get last 12 months
            const months = [];
            for (let i = 11; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
            }
            
            const reportData = [];
            
            months.forEach(month => {
                const [monthName, year] = month.split(' ');
                const monthIndex = monthNames.indexOf(monthName);
                const yearNum = parseInt(year);
                
                const row = { Month: month };
                
                processes.forEach(process => {
                    const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                    const count = data.filter(item => {
                        const itemDate = new Date(item.timestamp || item.handover_date || item.visit_date || item.movein_date);
                        return itemDate.getMonth() === monthIndex && itemDate.getFullYear() === yearNum;
                    }).length;
                    
                    row[process.replace('_', ' ').toUpperCase()] = count;
                });
                
                reportData.push(row);
            });
            
            exportToCSV(reportData, 'monthly_trends_report.csv', 'Monthly Trends Report');
        }
        
        function downloadTowerPerformanceReport() {
            const towers = BUILDING_CONFIG.towers;
            const processes = ['key_handover', 'snagging', 'project_mep', 'crm', 'first_visit', 'handover', 'interiors', 'movein'];
            
            const reportData = [];
            
            towers.forEach(tower => {
                const row = { Tower: tower };
                
                processes.forEach(process => {
                    const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                    const count = data.filter(item => 
                        item.tower === tower && !isRefugeFlat(item.flat)
                    ).length;
                    
                    row[process.replace('_', ' ').toUpperCase()] = count;
                });
                
                reportData.push(row);
            });
            
            exportToCSV(reportData, 'tower_performance_report.csv', 'Tower Performance Report');
        }
        
        function downloadSnaggingReport() {
            const snaggingData = JSON.parse(localStorage.getItem('hoto_snagging') || '[]');
            
            const reportData = snaggingData.map(item => {
                const checkboxes = ['mep_completed', 'civil_completed', 'electrical_completed', 
                                  'water_completed', 'ac_drain_completed', 'tiles_completed'];
                const completedCount = checkboxes.filter(field => item[field] === 'Yes').length;
                const status = completedCount === 6 ? 'Completed' : 
                              completedCount > 0 ? 'In Progress' : 'Not Started';
                
                return {
                    Tower: item.tower,
                    Flat: item.flat,
                    'MEP Inspector': item.mep_inspector || '',
                    'MEP Start Date': item.mep_start_date || '',
                    'MEP End Date': item.mep_end_date || '',
                    'MEP Status': item.mep_completed || 'No',
                    'Civil Inspector': item.civil_inspector || '',
                    'Civil Start Date': item.civil_start_date || '',
                    'Civil End Date': item.civil_end_date || '',
                    'Civil Status': item.civil_completed || 'No',
                    'Electrical Inspector': item.electrical_inspector || '',
                    'Electrical Start Date': item.electrical_start_date || '',
                    'Electrical End Date': item.electrical_end_date || '',
                    'Electrical Status': item.electrical_completed || 'No',
                    'Water Inspector': item.water_inspector || '',
                    'Water Start Date': item.water_start_date || '',
                    'Water End Date': item.water_end_date || '',
                    'Water Status': item.water_completed || 'No',
                    'AC Drain Inspector': item.ac_drain_inspector || '',
                    'AC Drain Start Date': item.ac_drain_start_date || '',
                    'AC Drain End Date': item.ac_drain_end_date || '',
                    'AC Drain Status': item.ac_drain_completed || 'No',
                    'Tiles Inspector': item.tiles_inspector || '',
                    'Tiles Start Date': item.tiles_start_date || '',
                    'Tiles End Date': item.tiles_end_date || '',
                    'Tiles Status': item.tiles_completed || 'No',
                    'Overall Status': status,
                    'Follow-up Date': item.followup_date || '',
                    'Remarks': item.remarks || ''
                };
            });
            
            exportToCSV(reportData, 'detailed_snagging_report.csv', 'Detailed Snagging Report');
        }
        
        function downloadWeeklyPerformanceReport() {
            // Get last 4 weeks
            const weeks = [];
            const weekLabels = [];
            
            for (let i = 3; i >= 0; i--) {
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - (i * 7) - 6);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                weekLabels.push(`Week ${4-i} (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`);
                weeks.push({start: startDate, end: endDate});
            }
            
            const processes = ['key_handover', 'snagging', 'handover', 'movein'];
            const reportData = [];
            
            weeks.forEach((week, index) => {
                const row = { Week: weekLabels[index] };
                
                processes.forEach(process => {
                    const data = JSON.parse(localStorage.getItem(`hoto_${process}`) || '[]');
                    const count = data.filter(item => {
                        const itemDate = new Date(item.timestamp || item.handover_date || item.visit_date || item.movein_date);
                        return itemDate >= week.start && itemDate <= week.end;
                    }).length;
                    
                    row[process.replace('_', ' ').toUpperCase()] = count;
                });
                
                reportData.push(row);
            });
            
            exportToCSV(reportData, 'weekly_performance_report.csv', 'Weekly Performance Report');
        }
        
        function exportToCSV(data, filename, title) {
            if (!data || data.length === 0) {
                showNotification(`No data to export for ${title}`, 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value}"` : value;
                });
                csvContent += values.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`${title} downloaded successfully!`, 'success');
        }
    </script>

<!-- ===== GOOGLE SHEETS LIVE SYNC CONFIG (ADDED) ===== -->
<script>
// üîπ PASTE YOUR WEB APP URL BELOW
APP_CONFIG.webAppUrl = "https://script.google.com/macros/s/AKfycbzNZjIIq6W8Iwj_EeO4mLBGILjYqjtaXm9NdoJygkyq3UFiGDRN_IJ7HncNCI3F2s9I-Q/exec";
APP_CONFIG.isConnected = true;

// Override save handlers to auto-sync
async function cloudUpsert(process, data){
  if(!APP_CONFIG.webAppUrl) return;
  await fetch(APP_CONFIG.webAppUrl + "?action=save_data&process=" + process, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({data})
  });
}

// Hook existing save functions
const _saveKeyHandover = window.saveKeyHandover;
window.saveKeyHandover = async function(){
  _saveKeyHandover();
  const payload = collectFormData('key_handover');
  await cloudUpsert('key_handover', payload);
};

const _saveSnagging = window.saveSnagging;
window.saveSnagging = async function(){
  _saveSnagging();
  const payload = collectFormData('snagging');
  await cloudUpsert('snagging', payload);
};
</script>

</body>
</html>